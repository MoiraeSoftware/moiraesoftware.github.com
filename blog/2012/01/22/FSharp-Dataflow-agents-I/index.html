
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>F# Dataflow Agents Part I - Moirae</title>
  <meta name="author" content="Dave Thomas">

  
  <meta name="description" content="This is going to be a new series on using TPL Dataflow with F#. First a little bit of history and background. TPL Dataflows heritage and background &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://MoiraeSoftware.com/blog/2012/01/22/FSharp-Dataflow-agents-I/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Moirae" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif|PT+Sans|Michroma:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-10152365-7']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Moirae</a></h1>
  
    <h2>Software Engineering Ltd</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:MoiraeSoftware.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/services.html">Services</a></li>
  <li><a href="/contact-us.html">Contact Us</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">F# Dataflow Agents Part I</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-01-22T12:28:00+00:00" pubdate data-updated="true">Jan 22<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>This is going to be a new series on using TPL Dataflow with F#.  First a little bit of history and background.</p>

<h2>TPL Dataflows heritage and background</h2>

<p>TPL Dataflow or <a href="http://msdn.microsoft.com/en-us/devlabs/gg585582">(TDF)</a> has been around for quite a
while, it first surfaced more than a year ago as the successor to the Concurrency and Coordination Runtime
<a href="http://msdn.microsoft.com/en-us/library/bb648752.aspx">(CCR)</a> and with coming release of .Net 4.5 it will
be part of the <code>System.Threading.Tasks.Dataflow</code> namespace.  Elements of the now halted project
<a href="http://msdn.microsoft.com/en-us/devlabs/dd795202">Axum</a> are also present within the design of TDF.</p>

<h3>Concurrency and Coordination Runtime (CCR)</h3>

<p>CCR is a library that deals with asynchrony, concurrency, and coordination between blocks of asynchronous
code so that the programmer doesn&#8217;t have to.  All of the low level details of synchronization and error
propagation are taken care of in a consistent fashion.  CCR is still is included in
<a href="ttp://www.microsoft.com/robotics/">Microsoft Robotics Studio</a> where it is used extensively to exploit
parallel hardware and deal with partial failure of systems.</p>

<h3>Axum</h3>

<p>Axum was another interesting Microsoft research project, it also utilized the actor model embracing the
principles of isolation, and message-passing.  There was also extensive use  symbolic operators as a terse
short hand way to indicate operations between actors.  For example <code>&lt;--</code> defined a way to pass a message
to an actor. Theres was also a similarity to CCR as Axum used the concepts of Ports and channels in a similar
way.  It was a very interesting project and it was a shame it was put on hold.</p>

<h3>TPL Dataflow (TDF)</h3>

<p>TDF builds on CCR and Axum, consolidating and refine to produce a more friendly fluent interface, much in
the same vain as Language-Integrated Query <a href="http://msdn.microsoft.com/en-us/library/bb308959.aspx">(LINQ)</a>
and Reactive Extensions <a href="http://msdn.microsoft.com/en-us/data/gg577609">(RX)</a>.</p>

<p>TDF is built around a number of different blocks which can be combined or linked together.  There are three
different categories of blocks are as follows:</p>

<h4>Buffering Blocks</h4>

<p>Buffering blocks simply buffer data in various ways before passing the data on to another block.</p>

<ul>
<li> <code>BufferBlock&lt;'T&gt;</code>  - The BufferBlock act as a first-in-first-out (FIFO) queue, buffering each input.</li>
<li> <code>BroadcastBlock&lt;'T&gt;</code> - The BroadcastBlock linking to multiple targets copying the data to each of the
connected blocks.</li>
<li> <code>WriteOnceBlock&lt;'T&gt;</code> - The WriteOnceBlock acts like an immutable target, after an item first item
is passed to it, it effectively becomes read only.</li>
</ul>


<h4>Executor Blocks</h4>

<p>The executor blocks run user supplied code in the form of a lambda expressions or a <code>Task&lt;'T&gt;</code>.</p>

<ul>
<li> <code>ActionBlock&lt;'TInput&gt;</code> - The ActionBlock acts like the <code>Action&lt;'T&gt;</code> delegate performing an action
on each datum posted to it.</li>
<li> <code>TransformBlock&lt;'TInput,'TOutput&gt;</code> - The TransformBlock acts just like the ActionBlock except
that the action performed can have an output, this output is buffered and behaves just like a BufferBlock.</li>
<li> <code>TransformManyBlock&lt;'TInput,'TOutput&gt;</code> - The TransformManyBlock is just like a TransformBlock except
that is can produce more than one output for a given datum.</li>
</ul>


<h4>Joining Blocks</h4>

<p>The Joining Blocks Combining or join data together in different ways.</p>

<ul>
<li> <code>BatchBlock&lt;'T&gt;</code> - The BatchBlock Combines multiple single items together, the items are
represented by arrays of elements.  The items are grouped together is batches and then passed on to
another block.</li>
<li> <code>JoinBlock&lt;'T1,'T2,…&gt;</code> - The JoinBlock acts as a form of <code>Enumerable.Zip&lt;'T1,'T2,'TResult&gt;</code>
except the zip operation is performed on the items in the source array.</li>
<li> <code>BatchedJoinBlock&lt;'T1,'T2,…&gt;</code> This block as the name suggests simply aggregates the JoinBlock and
the BatchBlock together.</li>
</ul>


<p>Thats an ultra high level tour thats only just scratches the surface.  I recommend you check out the
<a href="http://www.microsoft.com/download/en/details.aspx?id=14782">Introduction to TPL Dataflow</a> document to read
up on the details.  Theres a few more resources in the <a href="http://msdn.microsoft.com/en-us/devlabs/gg585582">DevLabs area</a>
that you might find useful.  Hopefully this series should also shed a bit more light on TDF as we go along&#8230;</p>

<h3>F# Asynchronous Workflows and Agents</h3>

<p>So where does that leave us in F#?<br/>
In F# we have <a href="http://msdn.microsoft.com/en-us/library/dd233250.aspx">Asynchronous Workflows</a> and
<a href="http://msdn.microsoft.com/en-us/library/ee370357.aspx">agents</a> and they help immensely in the concurrency
and message passing, but that doest mean that we cant take advantage of the new features and refinements
much in the same way as we can use Asynchronous Workflows to take advantage of Tasks.</p>

<p>This post is going to be centered around F# agents but with a twist.  First of all are going to be
reimplementing a MailboxProcessor using TDF for the underlying processing.  This will allow us to to use
all of our existing agent code and examples and also stay within the F# agent paradigm.  Following this
approach we could also make use of the <code>DataflowBlockOptions</code> type, it has some interesting
properties which we will look at in future posts:</p>

<ul>
<li> TaskScheduler</li>
<li> CancellationToken</li>
<li> MaxMessagesPerTask</li>
<li> BoundedCapacity</li>
</ul>


<h3>Implementation</h3>

<p>In this post we are going replicate the MailboxProcessor, we will be using Tomas Petricek&#8217;s caching agent
example from <a href="http://fssnip.net/8V">FSSnip</a>).  I have made a couple of modification to Tomas&#8217;s code.<br/>
I replaced the Dictionary type with a ConcurrentDictionary so that the caching agent could be called multiple
times successively without the dictionary throwing an exception due to it already containing a key from a
previous cached result.  I also changed the example code so that it requests cached HTML from the caching
agent ten times with a 400ms interval in between each.</p>

<figure class='code'><figcaption><span>Caching Agent Implementation  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nc">TplAgents</span>
</span><span class='line'><span class="k">open</span> <span class="nc">System</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Collections</span><span class="p">.</span><span class="nc">Generic</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Collections</span><span class="p">.</span><span class="nc">Concurrent</span>
</span><span class='line'><span class="k">open</span> <span class="nc">FsDataflow</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Net</span>
</span><span class='line'><span class="k">open</span> <span class="nn">Microsoft</span><span class="p">.</span><span class="nn">FSharp</span><span class="p">.</span><span class="nn">Control</span><span class="p">.</span><span class="nc">WebExtensions</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">CachingMessage</span> <span class="o">=</span>
</span><span class='line'><span class="o">|</span> <span class="nc">Add</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="kt">string</span>
</span><span class='line'><span class="o">|</span> <span class="nc">Get</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">*</span> <span class="nc">AsyncReplyChannel</span><span class="o">&lt;</span><span class="n">option</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;&gt;</span>
</span><span class='line'><span class="o">|</span> <span class="nc">Clear</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">caching</span> <span class="o">=</span> <span class="nn">DataflowAgent</span><span class="p">.</span><span class="nc">Start</span><span class="o">(</span><span class="k">fun</span> <span class="n">agent</span> <span class="o">-&gt;</span> <span class="n">async</span> <span class="o">{</span>
</span><span class='line'>   <span class="k">let</span> <span class="n">table</span> <span class="o">=</span> <span class="nc">ConcurrentDictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="kt">string</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class='line'>   <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
</span><span class='line'>      <span class="k">let</span><span class="o">!</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="nc">Receive</span><span class="bp">()</span>
</span><span class='line'>      <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
</span><span class='line'>      <span class="o">|</span> <span class="nc">Add</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">html</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>         <span class="c1">// Add downloaded page to the cache</span>
</span><span class='line'>         <span class="n">table</span><span class="o">.</span><span class="nc">AddOrUpdate</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">html</span><span class="o">,</span> <span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">html</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class='line'>      <span class="o">|</span> <span class="nc">Get</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">repl</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>         <span class="c1">// Get a page from the cache - returns </span>
</span><span class='line'>         <span class="c1">// None if the value isn&#39;t in the cache</span>
</span><span class='line'>         <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="nc">ContainsKey</span><span class="o">(</span><span class="n">url</span><span class="o">)</span> <span class="k">then</span>
</span><span class='line'>            <span class="n">repl</span><span class="o">.</span><span class="nc">Reply</span><span class="o">(</span><span class="nc">Some</span> <span class="n">table</span><span class="o">.[</span><span class="n">url</span><span class="o">])</span>
</span><span class='line'>         <span class="k">else</span>
</span><span class='line'>            <span class="n">repl</span><span class="o">.</span><span class="nc">Reply</span><span class="o">(</span><span class="nc">None</span><span class="o">)</span>
</span><span class='line'>      <span class="o">|</span> <span class="nc">Clear</span> <span class="o">-&gt;</span>
</span><span class='line'>           <span class="n">table</span><span class="o">.</span><span class="nc">Clear</span><span class="bp">()</span> <span class="o">})</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Caching Agent Example  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="c1">/// Prints information about the specified web site using cache</span>
</span><span class='line'><span class="k">let</span> <span class="n">printInfo</span> <span class="n">url</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class='line'>   <span class="c1">// Try to get the cached HTML from the caching agent</span>
</span><span class='line'>   <span class="k">let</span><span class="o">!</span> <span class="n">htmlOpt</span> <span class="o">=</span> <span class="n">caching</span><span class="o">.</span><span class="nc">PostAndAsyncReply</span><span class="o">(</span><span class="k">fun</span> <span class="n">ch</span> <span class="o">-&gt;</span> <span class="nc">Get</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">ch</span><span class="o">))</span>
</span><span class='line'>   <span class="k">match</span> <span class="n">htmlOpt</span> <span class="k">with</span>
</span><span class='line'>   <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
</span><span class='line'>       <span class="c1">// New url - download it and add it to the cache</span>
</span><span class='line'>       <span class="k">use</span> <span class="n">wc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WebClient</span><span class="bp">()</span>
</span><span class='line'>       <span class="k">let</span><span class="o">!</span> <span class="n">text</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="nc">AsyncDownloadString</span><span class="o">(</span><span class="nc">Uri</span><span class="o">(</span><span class="n">url</span><span class="o">))</span>
</span><span class='line'>       <span class="n">caching</span><span class="o">.</span><span class="nc">Post</span><span class="o">(</span><span class="nc">Add</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">text</span><span class="o">))</span>
</span><span class='line'>       <span class="nn">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="o">(</span> <span class="n">sprintf</span> <span class="s2">&quot;Download: %s (%d)&quot;</span> <span class="n">url</span> <span class="n">text</span><span class="o">.</span><span class="nc">Length</span><span class="o">)</span>
</span><span class='line'>   <span class="o">|</span> <span class="nc">Some</span> <span class="n">html</span> <span class="o">-&gt;</span>
</span><span class='line'>       <span class="c1">// The url was downloaded earlier </span>
</span><span class='line'>       <span class="nn">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="o">(</span> <span class="n">sprintf</span> <span class="s2">&quot;Cached: %s (%d)&quot;</span> <span class="n">url</span> <span class="n">html</span><span class="o">.</span><span class="nc">Length</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">printfuncpro</span> <span class="o">=</span> <span class="n">printInfo</span> <span class="s2">&quot;http://functional-programming.net&quot;</span>
</span><span class='line'><span class="c1">// Print information about a web site -</span>
</span><span class='line'><span class="c1">// Run this repeatedly to use cached value</span>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span> <span class="o">..</span> <span class="mi">10</span> <span class="k">do</span>
</span><span class='line'>   <span class="n">printfuncpro</span> <span class="o">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">Start</span>
</span><span class='line'>   <span class="nn">Async</span><span class="p">.</span><span class="nc">RunSynchronously</span> <span class="o">&lt;|</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">Sleep</span> <span class="mi">400</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Clear the cache - &#39;printInfo&#39; will need to</span>
</span><span class='line'><span class="c1">// download data from the web site again</span>
</span><span class='line'><span class="nn">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="o">(</span><span class="n">sprintf</span> <span class="s2">&quot;Clearing the cache&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">caching</span><span class="o">.</span><span class="nc">Post</span><span class="o">(</span><span class="nc">Clear</span><span class="o">)</span>
</span><span class='line'><span class="n">printfuncpro</span> <span class="o">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">Start</span>
</span><span class='line'>
</span><span class='line'><span class="nn">Console</span><span class="p">.</span><span class="nc">ReadKey</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span></code></pre></td></tr></table></div></figure>


<p>Looking at the implementation above you can see that we need to implement the following members:</p>

<ul>
<li> Start:<code>unit -&gt; unit</code></li>
<li> Receive:<code>?int -&gt; Async&lt;'Msg&gt;</code></li>
<li> Post:<code>'Msg -&gt; unit</code></li>
<li> PostAndTryAsyncReply:<code>(AsyncReplyChannel&lt;'Reply&gt; -&gt; 'Msg) * ?int -&gt; Async&lt;'Reply option&gt;</code></li>
<li> PostAndAsyncReply:<code>(AsyncReplyChannel&lt;'Reply&gt; -&gt; 'Msg) * int option -&gt; Async&lt;'Reply&gt;</code></li>
<li> static member Start:<code>(MailboxProcessor&lt;'Msg&gt; -&gt; Async&lt;unit&gt;) * ?CancellationToken -&gt; MailboxProcessor&lt;'Msg&gt;</code></li>
</ul>


<p>These are the only members we need to complete the caching agent example, I didn&#8217;t want bamboozle everyone
with an explosion of code from the onset so the remaining members will be implemented as and when we need
them.  When we have implemented all the members from MailboxProcessor Ill post the full source on my
 <a href="https://github.com/7sharp9">GitHub</a> account.</p>

<p> The following members will be outstanding but it should be fairly trivial to implement them
 once we have completed the code here.</p>

<ul>
<li> PostAndReply:<code>(AsyncReplyChannel&lt;'Reply&gt; -&gt; 'Msg) * int option -&gt; 'Reply</code></li>
<li> Scan:<code>('Msg -&gt; Async&lt;'T&gt; option) * ?int -&gt; Async&lt;'T&gt;</code></li>
<li> TryPostAndReply:<code>(AsyncReplyChannel&lt;'Reply&gt; -&gt; 'Msg) * ?int -&gt; 'Reply option</code></li>
<li> TryReceive:<code>?int -&gt; Async&lt;'Msg option&gt;</code></li>
<li> TryScan:<code>('Msg -&gt; Async&lt;'T&gt; option) * ?int -&gt; Async&lt;'T option&gt;</code></li>
<li> CurrentQueueLength:<code>int</code></li>
<li> DefaultTimeout:<code>int with get, set</code></li>
</ul>


<p>So here we go, this is the Dataflow implementation of the MailboxProcessor:</p>

<figure class='code'><figcaption><span>Dataflow Agent  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nc">FsDataflow</span>
</span><span class='line'><span class="k">open</span> <span class="nc">System</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Threading</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Threading</span><span class="p">.</span><span class="nc">Tasks</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Threading</span><span class="p">.</span><span class="nn">Tasks</span><span class="p">.</span><span class="nc">Dataflow</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Collections</span><span class="p">.</span><span class="nc">Concurrent</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">DataflowAgent</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="nc">Msg</span><span class="o">&gt;(</span><span class="n">initial</span><span class="o">,</span> <span class="o">?</span><span class="n">cancellationToken</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">cancellationToken</span> <span class="o">=</span>
</span><span class='line'>        <span class="n">defaultArg</span> <span class="n">cancellationToken</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">DefaultCancellationToken</span>
</span><span class='line'>    <span class="k">let</span> <span class="k">mutable</span> <span class="n">started</span> <span class="o">=</span> <span class="bp">false</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">errorEvent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Event</span><span class="o">&lt;</span><span class="nn">System</span><span class="p">.</span><span class="nc">Exception</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">incomingMessages</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferBlock</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="nc">Msg</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class='line'>    <span class="k">let</span> <span class="k">mutable</span> <span class="n">defaultTimeout</span> <span class="o">=</span> <span class="nn">Timeout</span><span class="p">.</span><span class="nc">Infinite</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">[&lt;</span><span class="nc">CLIEvent</span><span class="o">&gt;]</span>
</span><span class='line'>    <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Error</span> <span class="o">=</span> <span class="n">errorEvent</span><span class="o">.</span><span class="nc">Publish</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Start</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">started</span>
</span><span class='line'>            <span class="k">then</span> <span class="n">raise</span> <span class="o">(</span><span class="k">new</span> <span class="nc">InvalidOperationException</span><span class="o">(</span><span class="s2">&quot;Already Started.&quot;</span><span class="o">))</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="n">started</span> <span class="o">&lt;-</span> <span class="bp">true</span>
</span><span class='line'>            <span class="k">let</span> <span class="n">comp</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span> <span class="k">try</span> <span class="k">do</span><span class="o">!</span> <span class="n">initial</span> <span class="n">this</span>
</span><span class='line'>                               <span class="k">with</span> <span class="n">error</span> <span class="o">-&gt;</span> <span class="n">errorEvent</span><span class="o">.</span><span class="nc">Trigger</span> <span class="n">error</span> <span class="o">}</span>
</span><span class='line'>            <span class="nn">Async</span><span class="p">.</span><span class="nc">Start</span><span class="o">(</span><span class="n">computation</span> <span class="o">=</span> <span class="n">comp</span><span class="o">,</span> <span class="n">cancellationToken</span> <span class="o">=</span> <span class="n">cancellationToken</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Receive</span><span class="o">(?</span><span class="n">timeout</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>        <span class="nn">Async</span><span class="p">.</span><span class="nc">AwaitTask</span> <span class="o">&lt;|</span> <span class="n">incomingMessages</span><span class="o">.</span><span class="nc">ReceiveAsync</span><span class="bp">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Post</span><span class="o">(</span><span class="n">item</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">posted</span> <span class="o">=</span> <span class="n">incomingMessages</span><span class="o">.</span><span class="nc">Post</span><span class="o">(</span><span class="n">item</span><span class="o">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="ow">not</span> <span class="n">posted</span> <span class="k">then</span>
</span><span class='line'>            <span class="n">raise</span> <span class="o">(</span><span class="nc">InvalidOperationException</span><span class="o">(</span><span class="s2">&quot;Incoming message buffer full.&quot;</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">PostAndTryAsyncReply</span><span class="o">(</span><span class="n">replyChannelMsg</span><span class="o">,</span> <span class="o">?</span><span class="n">timeout</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">defaultArg</span> <span class="n">timeout</span> <span class="n">defaultTimeout</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">resultCell</span> <span class="o">=</span> <span class="nc">AsyncResultCell</span><span class="o">&lt;_&gt;</span><span class="bp">()</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">replyChannelMsg</span><span class="o">(</span><span class="nc">AsyncReplyChannel</span><span class="o">&lt;_&gt;(</span><span class="k">fun</span> <span class="n">reply</span> <span class="o">-&gt;</span> <span class="n">resultCell</span><span class="o">.</span><span class="nc">RegisterResult</span><span class="o">(</span><span class="n">reply</span><span class="o">)))</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">posted</span> <span class="o">=</span> <span class="n">incomingMessages</span><span class="o">.</span><span class="nc">Post</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">posted</span> <span class="k">then</span>
</span><span class='line'>            <span class="k">match</span> <span class="n">timeout</span> <span class="k">with</span>
</span><span class='line'>            <span class="o">|</span>   <span class="nn">Threading</span><span class="p">.</span><span class="nn">Timeout</span><span class="p">.</span><span class="nc">Infinite</span> <span class="o">-&gt;</span>
</span><span class='line'>                    <span class="n">async</span> <span class="o">{</span> <span class="k">let</span><span class="o">!</span> <span class="n">result</span> <span class="o">=</span> <span class="n">resultCell</span><span class="o">.</span><span class="nc">AsyncWaitResult</span>
</span><span class='line'>                            <span class="k">return</span> <span class="nc">Some</span><span class="o">(</span><span class="n">result</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>            <span class="o">|</span>   <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class='line'>                    <span class="n">async</span> <span class="o">{</span> <span class="k">let</span><span class="o">!</span> <span class="n">ok</span> <span class="o">=</span>  <span class="n">resultCell</span><span class="o">.</span><span class="nc">GetWaitHandle</span><span class="o">(</span><span class="n">timeout</span><span class="o">)</span>
</span><span class='line'>                            <span class="k">let</span> <span class="n">res</span> <span class="o">=</span> <span class="o">(</span><span class="k">if</span> <span class="n">ok</span> <span class="k">then</span> <span class="nc">Some</span><span class="o">(</span><span class="n">resultCell</span><span class="o">.</span><span class="nc">GrabResult</span><span class="bp">()</span><span class="o">)</span> <span class="k">else</span> <span class="nc">None</span><span class="o">)</span>
</span><span class='line'>                            <span class="k">return</span> <span class="n">res</span> <span class="o">}</span>
</span><span class='line'>        <span class="k">else</span> <span class="n">async</span><span class="o">{</span><span class="k">return</span> <span class="nc">None</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">PostAndAsyncReply</span><span class="o">(</span> <span class="n">replyChannelMsg</span><span class="o">,</span> <span class="o">?</span><span class="n">timeout</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>            <span class="k">let</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">defaultArg</span> <span class="n">timeout</span> <span class="n">defaultTimeout</span>
</span><span class='line'>            <span class="k">match</span> <span class="n">timeout</span> <span class="k">with</span>
</span><span class='line'>            <span class="o">|</span>   <span class="nn">Threading</span><span class="p">.</span><span class="nn">Timeout</span><span class="p">.</span><span class="nc">Infinite</span> <span class="o">-&gt;</span>
</span><span class='line'>                <span class="k">let</span> <span class="n">resCell</span> <span class="o">=</span> <span class="nc">AsyncResultCell</span><span class="o">&lt;_&gt;</span><span class="bp">()</span>
</span><span class='line'>                <span class="k">let</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">replyChannelMsg</span> <span class="o">(</span><span class="nc">AsyncReplyChannel</span><span class="o">&lt;_&gt;(</span><span class="k">fun</span> <span class="n">reply</span> <span class="o">-&gt;</span> <span class="n">resCell</span><span class="o">.</span><span class="nc">RegisterResult</span><span class="o">(</span><span class="n">reply</span><span class="o">)</span> <span class="o">))</span>
</span><span class='line'>                <span class="k">let</span> <span class="n">posted</span> <span class="o">=</span> <span class="n">incomingMessages</span><span class="o">.</span><span class="nc">Post</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">posted</span> <span class="k">then</span>
</span><span class='line'>                    <span class="n">resCell</span><span class="o">.</span><span class="nc">AsyncWaitResult</span>
</span><span class='line'>                <span class="k">else</span>
</span><span class='line'>                    <span class="n">raise</span> <span class="o">(</span><span class="nc">InvalidOperationException</span><span class="o">(</span><span class="s2">&quot;Incoming message buffer full.&quot;</span><span class="o">))</span>
</span><span class='line'>            <span class="o">|</span>   <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class='line'>                <span class="k">let</span> <span class="n">asyncReply</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="nc">PostAndTryAsyncReply</span><span class="o">(</span><span class="n">replyChannelMsg</span><span class="o">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="o">)</span>
</span><span class='line'>                <span class="n">async</span> <span class="o">{</span> <span class="k">let</span><span class="o">!</span> <span class="n">res</span> <span class="o">=</span> <span class="n">asyncReply</span>
</span><span class='line'>                        <span class="k">match</span> <span class="n">res</span> <span class="k">with</span>
</span><span class='line'>                        <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>  <span class="k">return</span><span class="o">!</span> <span class="n">raise</span> <span class="o">(</span><span class="nc">TimeoutException</span><span class="o">(</span><span class="s2">&quot;PostAndAsyncReply TimedOut&quot;</span><span class="o">))</span>
</span><span class='line'>                        <span class="o">|</span> <span class="nc">Some</span> <span class="n">res</span> <span class="o">-&gt;</span> <span class="k">return</span> <span class="n">res</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">static</span> <span class="k">member</span> <span class="nc">Start</span><span class="o">(</span><span class="n">initial</span><span class="o">,</span> <span class="o">?</span><span class="n">cancellationToken</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">dfa</span> <span class="o">=</span> <span class="nc">DataflowAgent</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="nc">Msg</span><span class="o">&gt;(</span><span class="n">initial</span><span class="o">,</span> <span class="o">?</span><span class="n">cancellationToken</span> <span class="o">=</span> <span class="n">cancellationToken</span><span class="o">)</span>
</span><span class='line'>        <span class="n">dfa</span><span class="o">.</span><span class="nc">Start</span><span class="bp">()</span>
</span><span class='line'>        <span class="n">dfa</span>
</span></code></pre></td></tr></table></div></figure>


<p>The crux of the implementation from TDF&#8217;s point of view is the use of the BufferBlock.<br/>
This is one of the most fundamental blocks within TDF.  Its the equivalent of the <code>Port&lt;'T&gt;</code>
type from CCR and the <code>Mailbox</code> type from F# which is used internally within the
MailboxProcessor.  As mentioned abouve the BufferBlock type is a first-in-first-out (FIFO) buffer
and is responsible for buffering any data that is Posted to it.</p>

<p>OK, I&#8217;m going to leave it at that for now while you digest the code presented here.</p>

<p>In part II I will be drilling into the detail on whats going on internally and also describing more
of the TDF model, so tune in soon for Part II.</p>

<p>Until next time&#8230;</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">7sharp9</span></span>

      








  


<time datetime="2012-01-22T12:28:00+00:00" pubdate data-updated="true">Jan 22<span>nd</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/agents/'>Agents</a>, <a class='category' href='/blog/categories/programming-tales/'>Programming Tales</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://MoiraeSoftware.com/blog/2012/01/22/FSharp-Dataflow-agents-I/" data-via="" data-counturl="http://MoiraeSoftware.com/blog/2012/01/22/FSharp-Dataflow-agents-I/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/01/08/moved-to-octopress/" title="Previous Post: Moved To Octopress...">&laquo; Moved To Octopress...</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/01/30/FSharp-Dataflow-agents-II/" title="next Post: F# Dataflow Agents Part II">F# Dataflow Agents Part II &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/07/15/the-lurking-horror/">The Lurking Horror</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/22/back-to-the-primitive-ii/">Back to the Primitive II</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/12/back-to-the-primitive/">Back to the Primitive</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/11/black-scholes-taste-test/">Black-Scholes Taste Test</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/20/fsharp-dataflow-agents-iii/">FSharp Dataflow agents III</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/30/FSharp-Dataflow-agents-II/">F# Dataflow Agents Part II</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/22/FSharp-Dataflow-agents-I/">F# Dataflow Agents Part I</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/08/moved-to-octopress/">Moved To Octopress...</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/11/fixing-a-hole/">Fixing a hole...</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/09/14/build-2011-a-quick-look/">Build 2011 - A quick look</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/7sharp9">@7sharp9</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        var blacklist = [];
        
          
            blacklist.push('nemerle');
          
            blacklist.push('FSharp.Javascript');
          
            blacklist.push('ServiceStack');
          
        

        github.showRepos({
            user: '7sharp9',
            count: 0,
            skip_forks: false,
            blacklist: blacklist,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Dave Thomas -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'moiraesoftware';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://MoiraeSoftware.com/blog/2012/01/22/FSharp-Dataflow-agents-I/';
        var disqus_url = 'http://MoiraeSoftware.com/blog/2012/01/22/FSharp-Dataflow-agents-I/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
