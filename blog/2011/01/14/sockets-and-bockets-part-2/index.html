
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Sockets and Bockets 2 - Moirae</title>
  <meta name="author" content="Dave Thomas">

  
  <meta name="description" content="Welcome to part two Lets jump in at the deep end and take a look at some code&#8230; When you look at the method syntax for the xxxAsync methods you &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://MoiraeSoftware.com/blog/2011/01/14/sockets-and-bockets-part-2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Moirae" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif|PT+Sans|Michroma:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-10152365-7']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Moirae</a></h1>
  
    <h2>Software Engineering Ltd</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:MoiraeSoftware.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/services.html">Services</a></li>
  <li><a href="/contact-us.html">Contact Us</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Sockets and Bockets 2</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-14T22:29:16+00:00" pubdate data-updated="true">Jan 14<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><h3>Welcome to part two</h3>

<p>Lets jump in at the deep end and take a look at some code&#8230;</p>

<p>When you look at the method syntax for the xxxAsync methods you will notice
they return a boolean value that indicates if the method completed
synchronously, this means that you have to check the return value every time
you use one of the methods and invoke the callback yourself if it completes
synchronously.  In practice this hardly ever happens, and normally only on a
send operation.  But as it is a possibility we will add module with a some
extension methods in to help us out, this will make the code more readable and
avoid unnecessary duplication.<!-- more --></p>

<h3>SocketExtensions</h3>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nc">SocketExtensions</span>
</span><span class='line'>  <span class="k">open</span> <span class="nc">System</span>
</span><span class='line'>  <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Net</span>
</span><span class='line'>  <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Net</span><span class="p">.</span><span class="nc">Sockets</span>
</span><span class='line'>  <span class="k">type</span> <span class="nc">Socket</span> <span class="k">with</span>
</span><span class='line'>    <span class="c1">/// extension method to make async based call easier, this ensures the callback always gets</span>
</span><span class='line'>    <span class="c1">/// called even if there is an error or the async method completed syncronously</span>
</span><span class='line'>    <span class="k">member</span> <span class="n">s</span><span class="o">.</span><span class="nc">InvokeAsyncMethod</span><span class="o">(</span> <span class="n">asyncmethod</span><span class="o">,</span> <span class="n">callback</span><span class="o">,</span> <span class="n">args</span><span class="o">:</span><span class="nc">SocketAsyncEventArgs</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>      <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">asyncmethod</span> <span class="n">args</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">result</span> <span class="o">&lt;&gt;</span> <span class="bp">true</span> <span class="k">then</span> <span class="n">callback</span> <span class="n">args</span>
</span><span class='line'>    <span class="k">member</span> <span class="n">s</span><span class="o">.</span><span class="nc">AcceptAsyncSafe</span><span class="o">(</span><span class="n">callback</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="nc">InvokeAsyncMethod</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="nc">AcceptAsync</span><span class="o">,</span> <span class="n">callback</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span>
</span><span class='line'>    <span class="k">member</span> <span class="n">s</span><span class="o">.</span><span class="nc">ReceiveAsyncSafe</span><span class="o">(</span><span class="n">callback</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="nc">InvokeAsyncMethod</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="nc">ReceiveAsync</span><span class="o">,</span> <span class="n">callback</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span>
</span><span class='line'>    <span class="k">member</span> <span class="n">s</span><span class="o">.</span><span class="nc">SendAsyncSafe</span><span class="o">(</span><span class="n">callback</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="nc">InvokeAsyncMethod</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="nc">SendAsync</span><span class="o">,</span> <span class="n">callback</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span>
</span><span class='line'>    <span class="k">member</span> <span class="n">s</span><span class="o">.</span><span class="nc">DisconnectAsyncSafe</span><span class="o">(</span><span class="n">callback</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="nc">InvokeAsyncMethod</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="nc">DisconnectAsync</span><span class="o">,</span> <span class="n">callback</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now lets get down to business, the next few types have a fair bit of code in
them so I will briefly explain each type in turn:</p>

<h3>BocketPool</h3>

<p>A BocketPool is a combination of a
<a href="http://msdn.microsoft.com/en-%0Aus/library/system.net.sockets.socketasynceventargs.aspx">SocketAsyncEventArgs</a> object and a chunk of
memory allocated in an array.  The array is sliced up into sections and
allocated for each send or receive operation by setting a start and end index
using <a href="http://msdn.microsoft.com/en-us/library/bb549836.aspx">SetBuffer()</a>.
If you remember last time I mentioned that a lot of memory fragmentation can
occur during sending and receiving due to continuously allocating memory
buffers on the Socket object, this is primarily done through the BeginSend and
BeginReceive methods passing in a byte array.  Using the BocketPool it a great
way of reducing the amount of garbage collection during heavy traffic.</p>

<p>The other major difference with SocketAsyncEventArgs is the way in which you
make the send and receive calls, heres the general flow that occurs:</p>

<ul>
<li>Create a SocketAsyncEventArgs object or get one from a pool.</li>
<li>Allocate an array to the buffer.</li>
<li>Allocate an offset and length to the buffer.</li>
<li>Allocate a callback method.</li>
<li>Call Socket.xxxAsync passing in the SocketAsyncEventArgs, the operation will complete and invoke the callback.</li>
</ul>


<p>What we are going to do is wrap the whole creation, array allocation, and
offsetting to the BocketPool:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'>    <span class="k">namespace</span> <span class="nc">Fes</span>
</span><span class='line'>      <span class="k">open</span> <span class="nc">System</span>
</span><span class='line'>      <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Net</span><span class="p">.</span><span class="nc">Sockets</span>
</span><span class='line'>      <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Collections</span><span class="p">.</span><span class="nc">Concurrent</span>
</span><span class='line'>      <span class="k">type</span> <span class="nc">BocketPool</span><span class="o">(</span> <span class="n">number</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">callback</span><span class="o">)</span> <span class="k">as</span> <span class="n">this</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">number</span> <span class="o">=</span> <span class="n">number</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">totalsize</span> <span class="o">=</span> <span class="o">(</span><span class="n">number</span> <span class="o">*</span> <span class="n">size</span><span class="o">)</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">create</span> <span class="n">totalsize</span> <span class="mi">0</span><span class="n">uy</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BlockingCollection</span><span class="o">&lt;</span><span class="nc">SocketAsyncEventArgs</span><span class="o">&gt;(</span><span class="n">number</span><span class="o">:</span><span class="kt">int</span><span class="o">)</span>
</span><span class='line'>        <span class="k">let</span> <span class="k">mutable</span> <span class="n">disposed</span> <span class="o">=</span> <span class="bp">false</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">cleanUp</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>          <span class="k">if</span> <span class="ow">not</span> <span class="n">disposed</span> <span class="k">then</span>
</span><span class='line'>            <span class="n">disposed</span> <span class="o">&lt;-</span> <span class="bp">true</span>
</span><span class='line'>            <span class="n">pool</span><span class="o">.</span><span class="nc">CompleteAdding</span><span class="bp">()</span>
</span><span class='line'>            <span class="k">while</span> <span class="n">pool</span><span class="o">.</span><span class="nc">Count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">do</span>
</span><span class='line'>              <span class="o">(</span><span class="n">pool</span><span class="o">.</span><span class="nc">Take</span><span class="bp">()</span> <span class="o">:&gt;</span> <span class="nc">IDisposable</span><span class="o">).</span><span class="nc">Dispose</span><span class="bp">()</span>
</span><span class='line'>            <span class="n">pool</span><span class="o">.</span><span class="nc">Dispose</span><span class="bp">()</span>
</span><span class='line'>        <span class="k">do</span>
</span><span class='line'>          <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">n</span> <span class="o">=</span>
</span><span class='line'>            <span class="k">match</span> <span class="n">n</span> <span class="k">with</span>
</span><span class='line'>            <span class="o">|</span> <span class="n">x</span> <span class="k">when</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">totalsize</span> <span class="o">-&gt;</span>
</span><span class='line'>              <span class="k">let</span> <span class="n">saea</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SocketAsyncEventArgs</span><span class="bp">()</span>
</span><span class='line'>              <span class="n">saea</span><span class="o">.</span><span class="nc">Completed</span> <span class="o">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">add</span><span class="o">(</span> <span class="k">fun</span> <span class="n">saea</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">callback</span> <span class="n">saea</span><span class="o">))</span>
</span><span class='line'>              <span class="n">saea</span><span class="o">.</span><span class="nc">SetBuffer</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">size</span><span class="o">)</span>
</span><span class='line'>              <span class="n">this</span><span class="o">.</span><span class="nc">CheckIn</span><span class="o">(</span><span class="n">saea</span><span class="o">)</span>
</span><span class='line'>              <span class="n">loop</span> <span class="o">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">size</span><span class="o">)</span>
</span><span class='line'>            <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
</span><span class='line'>          <span class="n">loop</span> <span class="mi">0</span>
</span><span class='line'>        <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">CheckOut</span><span class="bp">()</span><span class="o">=</span>
</span><span class='line'>          <span class="n">pool</span><span class="o">.</span><span class="nc">Take</span><span class="bp">()</span>
</span><span class='line'>        <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">CheckIn</span><span class="o">(</span><span class="n">saea</span><span class="o">)=</span>
</span><span class='line'>          <span class="n">pool</span><span class="o">.</span><span class="nc">Add</span><span class="o">(</span><span class="n">saea</span><span class="o">)</span>
</span><span class='line'>        <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Count</span> <span class="o">=</span>
</span><span class='line'>          <span class="n">pool</span><span class="o">.</span><span class="nc">Count</span>
</span><span class='line'>        <span class="k">interface</span> <span class="nc">IDisposable</span> <span class="k">with</span>
</span><span class='line'>          <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Dispose</span><span class="bp">()</span> <span class="o">=</span> <span class="n">cleanUp</span><span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next up we have to look at the Connection and the Tcplistener types as two
interconnected entities:</p>

<ul>
<li>The TcpListener listens for a connection on a socket and port number.</li>
<li>The client connects to the server.</li>
<li>An accept socket is allocated to the client, at this point we have one socket for the server and once for each client.</li>
<li>We also need to allocate a BocketPool for send and receive operation for each client
To simplify things we are going to encapsulate the accept socket management
into a type, it will also need a corresponding BocketPool to service any send
and receive operations to and from the client</li>
</ul>


<h3>Connection</h3>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'>    <span class="k">namespace</span> <span class="nc">Fes</span>
</span><span class='line'>      <span class="k">open</span> <span class="nc">System</span>
</span><span class='line'>      <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Net</span>
</span><span class='line'>      <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Net</span><span class="p">.</span><span class="nc">Sockets</span>
</span><span class='line'>      <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Collections</span><span class="p">.</span><span class="nc">Generic</span>
</span><span class='line'>      <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Collections</span><span class="p">.</span><span class="nc">Concurrent</span>
</span><span class='line'>      <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Threading</span>
</span><span class='line'>      <span class="k">open</span> <span class="nc">SocketExtensions</span>
</span><span class='line'>      <span class="k">type</span> <span class="nc">Connection</span><span class="o">(</span><span class="n">maxreceives</span><span class="o">,</span> <span class="n">maxsends</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">socket</span><span class="o">:</span><span class="nc">Socket</span><span class="o">)</span> <span class="k">as</span> <span class="n">this</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">maxreceives</span> <span class="o">=</span> <span class="n">maxreceives</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">maxsends</span> <span class="o">=</span> <span class="n">maxsends</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">sendPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BocketPool</span><span class="o">(</span><span class="n">maxsends</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">this</span><span class="o">.</span><span class="n">sendCompleted</span> <span class="o">)</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">receivePool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BocketPool</span><span class="o">(</span><span class="n">maxreceives</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">this</span><span class="o">.</span><span class="n">receiveCompleted</span><span class="o">)</span>
</span><span class='line'>        <span class="k">let</span> <span class="k">mutable</span> <span class="n">disposed</span> <span class="o">=</span> <span class="bp">false</span>
</span><span class='line'>        <span class="k">let</span> <span class="k">mutable</span> <span class="n">anyErrors</span> <span class="o">=</span> <span class="bp">false</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">cleanUp</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>          <span class="k">if</span> <span class="ow">not</span> <span class="n">disposed</span> <span class="k">then</span>
</span><span class='line'>            <span class="n">disposed</span> <span class="o">&lt;-</span> <span class="bp">true</span>
</span><span class='line'>            <span class="n">socket</span><span class="o">.</span><span class="nc">Shutdown</span><span class="o">(</span><span class="nn">SocketShutdown</span><span class="p">.</span><span class="nc">Both</span><span class="o">)</span>
</span><span class='line'>            <span class="n">socket</span><span class="o">.</span><span class="nc">Disconnect</span><span class="o">(</span><span class="bp">false</span><span class="o">)</span>
</span><span class='line'>            <span class="n">socket</span><span class="o">.</span><span class="nc">Close</span><span class="bp">()</span>
</span><span class='line'>            <span class="o">(</span><span class="n">sendPool</span> <span class="o">:&gt;</span> <span class="nc">IDisposable</span><span class="o">).</span><span class="nc">Dispose</span><span class="bp">()</span>
</span><span class='line'>            <span class="o">(</span><span class="n">receivePool</span> <span class="o">:&gt;</span> <span class="nc">IDisposable</span><span class="o">).</span><span class="nc">Dispose</span><span class="bp">()</span>
</span><span class='line'>        <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Start</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>          <span class="n">socket</span><span class="o">.</span><span class="nc">ReceiveAsyncSafe</span><span class="o">(</span><span class="n">this</span><span class="o">.</span><span class="n">receiveCompleted</span><span class="o">,</span> <span class="n">receivePool</span><span class="o">.</span><span class="nc">CheckOut</span><span class="bp">()</span><span class="o">)</span>
</span><span class='line'>        <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Stop</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>          <span class="n">socket</span><span class="o">.</span><span class="nc">Close</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'>        <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="n">receiveCompleted</span> <span class="o">(</span><span class="n">args</span><span class="o">:</span> <span class="nc">SocketAsyncEventArgs</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>          <span class="k">try</span>
</span><span class='line'>            <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="nc">LastOperation</span> <span class="k">with</span>
</span><span class='line'>            <span class="o">|</span> <span class="nn">SocketAsyncOperation</span><span class="p">.</span><span class="nc">Receive</span> <span class="o">-&gt;</span>
</span><span class='line'>              <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="nc">SocketError</span> <span class="k">with</span>
</span><span class='line'>              <span class="o">|</span> <span class="nn">SocketError</span><span class="p">.</span><span class="nc">Success</span> <span class="o">-&gt;</span>
</span><span class='line'>                <span class="n">socket</span><span class="o">.</span><span class="nc">ReceiveAsyncSafe</span><span class="o">(</span> <span class="n">this</span><span class="o">.</span><span class="n">receiveCompleted</span><span class="o">,</span> <span class="n">receivePool</span><span class="o">.</span><span class="nc">CheckOut</span><span class="bp">()</span><span class="o">)</span>
</span><span class='line'>                <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">create</span> <span class="n">args</span><span class="o">.</span><span class="nc">BytesTransferred</span> <span class="mi">0</span><span class="n">uy</span>
</span><span class='line'>                <span class="nn">Buffer</span><span class="p">.</span><span class="nc">BlockCopy</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="nc">Buffer</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="nc">Offset</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="nc">Length</span><span class="o">)</span>
</span><span class='line'>                <span class="k">let</span> <span class="n">client</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="nc">RemoteEndPoint</span>
</span><span class='line'>                <span class="n">args</span><span class="o">.</span><span class="nc">RemoteEndPoint</span> <span class="o">&lt;-</span> <span class="k">null</span>
</span><span class='line'>                <span class="n">data</span> <span class="o">|&gt;</span> <span class="n">printfn</span> <span class="s2">&quot;received data: %A&quot;</span>
</span><span class='line'>              <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">args</span><span class="o">.</span><span class="nn">SocketError</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">printfn</span> <span class="s2">&quot;socket error on receive: %s&quot;</span>
</span><span class='line'>            <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">&quot;unknown operation, should be receive&quot;</span>
</span><span class='line'>          <span class="k">finally</span>
</span><span class='line'>            <span class="n">receivePool</span><span class="o">.</span><span class="nc">CheckIn</span><span class="o">(</span><span class="n">args</span><span class="o">)</span>
</span><span class='line'>        <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="n">sendCompleted</span> <span class="o">(</span><span class="n">args</span><span class="o">:</span> <span class="nc">SocketAsyncEventArgs</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>          <span class="k">try</span>
</span><span class='line'>            <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="nc">LastOperation</span> <span class="k">with</span>
</span><span class='line'>            <span class="o">|</span> <span class="nn">SocketAsyncOperation</span><span class="p">.</span><span class="nc">Send</span> <span class="o">-&gt;</span>
</span><span class='line'>              <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="nc">SocketError</span> <span class="k">with</span>
</span><span class='line'>              <span class="o">|</span> <span class="nn">SocketError</span><span class="p">.</span><span class="nc">Success</span> <span class="o">-&gt;</span> <span class="bp">()</span>
</span><span class='line'>              <span class="o">|</span> <span class="nn">SocketError</span><span class="p">.</span><span class="nc">NoBufferSpaceAvailable</span>
</span><span class='line'>              <span class="o">|</span> <span class="nn">SocketError</span><span class="p">.</span><span class="nc">IOPending</span>
</span><span class='line'>              <span class="o">|</span> <span class="nn">SocketError</span><span class="p">.</span><span class="nc">WouldBlock</span> <span class="o">-&gt;</span>
</span><span class='line'>                <span class="k">if</span> <span class="ow">not</span><span class="o">(</span><span class="n">anyErrors</span><span class="o">)</span> <span class="k">then</span>
</span><span class='line'>                  <span class="n">anyErrors</span> <span class="o">&lt;-</span> <span class="bp">true</span>
</span><span class='line'>                  <span class="n">failwith</span> <span class="s2">&quot;Buffer overflow or send buffer timeout&quot;</span>
</span><span class='line'>              <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">args</span><span class="o">.</span><span class="nn">SocketError</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">printfn</span> <span class="s2">&quot;socket error on send: %s&quot;</span>
</span><span class='line'>            <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">&quot;invalid operation, should be receive&quot;</span>
</span><span class='line'>          <span class="k">finally</span>
</span><span class='line'>            <span class="n">sendPool</span><span class="o">.</span><span class="nc">CheckIn</span><span class="o">(</span><span class="n">args</span><span class="o">)</span>
</span><span class='line'>        <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Send</span> <span class="o">(</span><span class="n">msg</span><span class="o">:</span><span class="kt">byte</span><span class="bp">[]</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>          <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sendPool</span><span class="o">.</span><span class="nc">CheckOut</span><span class="bp">()</span>
</span><span class='line'>          <span class="nn">Buffer</span><span class="p">.</span><span class="nc">BlockCopy</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="nc">Buffer</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="nc">Offset</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="nc">Length</span><span class="o">)</span>
</span><span class='line'>          <span class="n">socket</span><span class="o">.</span><span class="nc">SendAsyncSafe</span><span class="o">(</span><span class="n">this</span><span class="o">.</span><span class="n">sendCompleted</span><span class="o">,</span> <span class="n">s</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally here&#8217;s the TcpListener type.  It is responsible for creating an
initial Connection object for each client and starts asynchronous sending
messages to that client once a second, also notice that there is another
BlockingCollection involved, this is somewhat simpler than the usage in the
bocketPool as we have no buffer to manage here.</p>

<ul>
<li><em>It is possible to fill the initial Buffer property, this causes the buffer to be sent to the client as soon as it has connected to the server, this can be useful to sent initial data to the client, such as protocol definitions etc)</em>
A finite number of connections can occur before blocking will occur depending
on the number of AsyncEventArgs in the collection, this stops potential denial
of service attacks due to too many connection being made.</li>
</ul>


<h3>TcpListener</h3>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'>    <span class="k">namespace</span> <span class="nc">Fes</span>
</span><span class='line'>      <span class="k">open</span> <span class="nc">System</span>
</span><span class='line'>      <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Net</span>
</span><span class='line'>      <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Net</span><span class="p">.</span><span class="nc">Sockets</span>
</span><span class='line'>      <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Collections</span><span class="p">.</span><span class="nc">Generic</span>
</span><span class='line'>      <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Collections</span><span class="p">.</span><span class="nc">Concurrent</span>
</span><span class='line'>      <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Threading</span>
</span><span class='line'>      <span class="k">open</span> <span class="nc">SocketExtensions</span>
</span><span class='line'>      <span class="k">type</span> <span class="nc">TcpListener</span><span class="o">(</span><span class="n">maxaccepts</span><span class="o">,</span> <span class="n">maxsends</span><span class="o">,</span> <span class="n">maxreceives</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">backlog</span><span class="o">)</span> <span class="k">as</span> <span class="n">this</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">createTcpSocket</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>          <span class="k">new</span> <span class="nc">Socket</span><span class="o">(</span><span class="nn">AddressFamily</span><span class="p">.</span><span class="nc">InterNetwork</span><span class="o">,</span> <span class="nn">SocketType</span><span class="p">.</span><span class="nc">Stream</span><span class="o">,</span> <span class="nn">ProtocolType</span><span class="p">.</span><span class="nc">Tcp</span><span class="o">)</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">createListener</span> <span class="o">(</span><span class="n">ip</span><span class="o">:</span><span class="nc">IPAddress</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">backlog</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>          <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">createTcpSocket</span><span class="bp">()</span>
</span><span class='line'>          <span class="n">s</span><span class="o">.</span><span class="nc">Bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">IPEndPoint</span><span class="o">(</span><span class="n">ip</span><span class="o">,</span> <span class="n">port</span><span class="o">))</span>
</span><span class='line'>          <span class="n">s</span><span class="o">.</span><span class="nc">Listen</span><span class="o">(</span><span class="n">backlog</span><span class="o">);</span> <span class="n">s</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">listeningSocket</span> <span class="o">=</span> <span class="n">createListener</span><span class="o">(</span> <span class="nn">IPAddress</span><span class="p">.</span><span class="nc">Loopback</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">backlog</span><span class="o">)</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">initPool</span> <span class="o">(</span><span class="n">maxinpool</span><span class="o">,</span> <span class="n">callback</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>          <span class="k">let</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BlockingCollection</span><span class="o">&lt;</span><span class="nc">SocketAsyncEventArgs</span><span class="o">&gt;(</span><span class="n">maxinpool</span><span class="o">:</span><span class="kt">int</span><span class="o">)</span>
</span><span class='line'>          <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">n</span> <span class="o">=</span>
</span><span class='line'>            <span class="k">match</span> <span class="n">n</span> <span class="k">with</span>
</span><span class='line'>            <span class="o">|</span> <span class="n">x</span> <span class="k">when</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">maxinpool</span> <span class="o">-&gt;</span>
</span><span class='line'>              <span class="k">let</span> <span class="n">saea</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SocketAsyncEventArgs</span><span class="bp">()</span>
</span><span class='line'>              <span class="n">saea</span><span class="o">.</span><span class="nc">Completed</span> <span class="o">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">add</span> <span class="n">callback</span>
</span><span class='line'>              <span class="n">pool</span><span class="o">.</span><span class="nc">Add</span> <span class="n">saea</span>
</span><span class='line'>              <span class="n">loop</span> <span class="o">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'>            <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
</span><span class='line'>          <span class="n">loop</span> <span class="mi">0</span>
</span><span class='line'>          <span class="n">pool</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">acceptPool</span> <span class="o">=</span> <span class="n">initPool</span> <span class="o">(</span><span class="n">maxaccepts</span><span class="o">,</span> <span class="n">this</span><span class="o">.</span><span class="n">acceptcompleted</span><span class="o">)</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">newConnection</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Connection</span> <span class="o">(</span><span class="n">maxreceives</span><span class="o">,</span> <span class="n">maxsends</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">socket</span><span class="o">)</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">testMessage</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">init</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">&gt;</span> <span class="mi">128</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="n">uy</span><span class="o">)</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">header</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">init</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">&gt;</span> <span class="mi">1</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="n">uy</span><span class="o">)</span>
</span><span class='line'>        <span class="k">let</span> <span class="k">mutable</span> <span class="n">disposed</span> <span class="o">=</span> <span class="bp">false</span>
</span><span class='line'>        <span class="c1">//mutable state from original</span>
</span><span class='line'>        <span class="k">let</span> <span class="k">mutable</span> <span class="n">anyErrors</span> <span class="o">=</span> <span class="bp">false</span>
</span><span class='line'>        <span class="k">let</span> <span class="k">mutable</span> <span class="n">requestCount</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="k">let</span> <span class="k">mutable</span> <span class="n">numWritten</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="c1">//async code from original</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">asyncWriteStockQuote</span><span class="o">(</span><span class="n">connection</span><span class="o">:</span><span class="nc">Connection</span><span class="o">)</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">do</span><span class="o">!</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">Sleep</span> <span class="mi">1000</span>
</span><span class='line'>          <span class="n">connection</span><span class="o">.</span><span class="nc">Send</span><span class="o">(</span><span class="n">testMessage</span><span class="o">)</span>
</span><span class='line'>          <span class="nn">Interlocked</span><span class="p">.</span><span class="nc">Increment</span><span class="o">(&amp;</span><span class="n">numWritten</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span> <span class="o">}</span>
</span><span class='line'>        <span class="c1">//async code from original</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">asyncServiceClient</span> <span class="o">(</span><span class="n">client</span><span class="o">:</span> <span class="nc">Connection</span><span class="o">)</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">client</span><span class="o">.</span><span class="nc">Send</span><span class="o">(</span><span class="n">header</span><span class="o">)</span>
</span><span class='line'>          <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
</span><span class='line'>            <span class="k">do</span><span class="o">!</span> <span class="n">asyncWriteStockQuote</span><span class="o">(</span><span class="n">client</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">startSending</span> <span class="n">connection</span> <span class="o">=</span>
</span><span class='line'>          <span class="nn">Async</span><span class="p">.</span><span class="nc">Start</span> <span class="o">(</span><span class="n">async</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span>
</span><span class='line'>              <span class="k">use</span> <span class="o">_</span><span class="n">holder</span> <span class="o">=</span> <span class="n">connection</span>
</span><span class='line'>              <span class="k">do</span><span class="o">!</span> <span class="n">asyncServiceClient</span> <span class="n">connection</span>
</span><span class='line'>            <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
</span><span class='line'>              <span class="k">if</span> <span class="ow">not</span><span class="o">(</span><span class="n">anyErrors</span><span class="o">)</span> <span class="k">then</span>
</span><span class='line'>                <span class="n">anyErrors</span> <span class="o">&lt;-</span> <span class="bp">true</span>
</span><span class='line'>                <span class="nn">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="o">(</span><span class="s2">&quot;server ERROR&quot;</span><span class="o">)</span>
</span><span class='line'>              <span class="n">raise</span> <span class="n">e</span>
</span><span class='line'>            <span class="o">}</span> <span class="o">)</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">reportConnections</span> <span class="o">=</span>
</span><span class='line'>          <span class="nn">Interlocked</span><span class="p">.</span><span class="nc">Increment</span><span class="o">(&amp;</span><span class="n">requestCount</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">requestCount</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span>
</span><span class='line'>            <span class="n">requestCount</span> <span class="o">|&gt;</span> <span class="n">printfn</span> <span class="s2">&quot;%A Clients accepted&quot;</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">cleanUp</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>          <span class="k">if</span> <span class="ow">not</span> <span class="n">disposed</span> <span class="k">then</span>
</span><span class='line'>            <span class="n">disposed</span> <span class="o">&lt;-</span> <span class="bp">true</span>
</span><span class='line'>            <span class="n">listeningSocket</span><span class="o">.</span><span class="nc">Shutdown</span><span class="o">(</span><span class="nn">SocketShutdown</span><span class="p">.</span><span class="nc">Both</span><span class="o">)</span>
</span><span class='line'>            <span class="n">listeningSocket</span><span class="o">.</span><span class="nc">Disconnect</span><span class="o">(</span><span class="bp">false</span><span class="o">)</span>
</span><span class='line'>            <span class="n">listeningSocket</span><span class="o">.</span><span class="nc">Close</span><span class="bp">()</span>
</span><span class='line'>        <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="n">acceptcompleted</span> <span class="o">(</span><span class="n">args</span> <span class="o">:</span> <span class="nc">SocketAsyncEventArgs</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>          <span class="k">try</span>
</span><span class='line'>            <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="nc">LastOperation</span> <span class="k">with</span>
</span><span class='line'>            <span class="o">|</span> <span class="nn">SocketAsyncOperation</span><span class="p">.</span><span class="nc">Accept</span> <span class="o">-&gt;</span>
</span><span class='line'>              <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="nc">SocketError</span> <span class="k">with</span>
</span><span class='line'>              <span class="o">|</span> <span class="nn">SocketError</span><span class="p">.</span><span class="nc">Success</span> <span class="o">-&gt;</span>
</span><span class='line'>                <span class="n">listeningSocket</span><span class="o">.</span><span class="nc">AcceptAsyncSafe</span><span class="o">(</span> <span class="n">this</span><span class="o">.</span><span class="n">acceptcompleted</span><span class="o">,</span> <span class="n">acceptPool</span><span class="o">.</span><span class="nc">Take</span><span class="bp">()</span><span class="o">)</span>
</span><span class='line'>                <span class="c1">//create new connection</span>
</span><span class='line'>                <span class="k">let</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">newConnection</span> <span class="n">args</span><span class="o">.</span><span class="nc">AcceptSocket</span>
</span><span class='line'>                <span class="n">connection</span><span class="o">.</span><span class="nc">Start</span><span class="bp">()</span>
</span><span class='line'>                <span class="c1">//update stats</span>
</span><span class='line'>                <span class="n">reportConnections</span>
</span><span class='line'>                <span class="c1">//async start of messages to client</span>
</span><span class='line'>                <span class="n">startSending</span> <span class="n">connection</span>
</span><span class='line'>                <span class="c1">//remove the AcceptSocket because we will be reusing args</span>
</span><span class='line'>                <span class="n">args</span><span class="o">.</span><span class="nc">AcceptSocket</span> <span class="o">&lt;-</span> <span class="k">null</span>
</span><span class='line'>              <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">args</span><span class="o">.</span><span class="nn">SocketError</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">printfn</span> <span class="s2">&quot;socket error on accept: %s&quot;</span>
</span><span class='line'>            <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">args</span><span class="o">.</span><span class="nc">LastOperation</span> <span class="o">|&gt;</span> <span class="n">failwith</span> <span class="s2">&quot;Unknown operation, should be accept but was %a&quot;</span>
</span><span class='line'>          <span class="k">finally</span>
</span><span class='line'>            <span class="n">acceptPool</span><span class="o">.</span><span class="nc">Add</span><span class="o">(</span><span class="n">args</span><span class="o">)</span>
</span><span class='line'>        <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="n">start</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>          <span class="n">listeningSocket</span><span class="o">.</span><span class="nc">AcceptAsyncSafe</span><span class="o">(</span> <span class="n">this</span><span class="o">.</span><span class="n">acceptcompleted</span><span class="o">,</span> <span class="n">acceptPool</span><span class="o">.</span><span class="nc">Take</span><span class="bp">()</span><span class="o">)</span>
</span><span class='line'>          <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
</span><span class='line'>          <span class="nn">Thread</span><span class="p">.</span><span class="nc">Sleep</span> <span class="mi">1000</span>
</span><span class='line'>          <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="nn">Interlocked</span><span class="p">.</span><span class="nc">Exchange</span><span class="o">(&amp;</span><span class="n">numWritten</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'>          <span class="n">count</span> <span class="o">|&gt;</span> <span class="n">printfn</span> <span class="s2">&quot;Quotes per sec: %A&quot;</span>
</span><span class='line'>        <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Close</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>          <span class="n">cleanUp</span><span class="bp">()</span>
</span><span class='line'>        <span class="k">interface</span> <span class="nc">IDisposable</span> <span class="k">with</span>
</span><span class='line'>          <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Dispose</span><span class="bp">()</span> <span class="o">=</span> <span class="n">cleanUp</span><span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Its a fair bit of code to take in at once, so Ill leave you with it to ponder
over.  Ill be explaining all of the interesting bits in more detail in part
three&#8230;</p>

<p>Please feel free to leave any comments you have, especially on better use of
functional constructs.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">7sharp9</span></span>

      








  


<time datetime="2011-01-14T22:29:16+00:00" pubdate data-updated="true">Jan 14<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/programming-tales/'>Programming Tales</a>, <a class='category' href='/blog/categories/sockets/'>Sockets</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://MoiraeSoftware.com/blog/2011/01/14/sockets-and-bockets-part-2/" data-via="" data-counturl="http://MoiraeSoftware.com/blog/2011/01/14/sockets-and-bockets-part-2/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/01/13/sockets-and-bockets-1/" title="Previous Post: Sockets and Bockets 1">&laquo; Sockets and Bockets 1</a>
      
      
        <a class="basic-alignment right" href="/blog/2011/01/20/sockets-and-bockets-part-3/" title="next Post: Sockets and Bockets 3">Sockets and Bockets 3 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/07/15/the-lurking-horror/">The Lurking Horror</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/22/back-to-the-primitive-ii/">Back to the Primitive II</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/12/back-to-the-primitive/">Back to the Primitive</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/11/black-scholes-taste-test/">Black-Scholes Taste Test</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/20/fsharp-dataflow-agents-iii/">FSharp Dataflow agents III</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/30/FSharp-Dataflow-agents-II/">F# Dataflow Agents Part II</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/22/FSharp-Dataflow-agents-I/">F# Dataflow Agents Part I</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/08/moved-to-octopress/">Moved To Octopress...</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/11/fixing-a-hole/">Fixing a hole...</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/09/14/build-2011-a-quick-look/">Build 2011 - A quick look</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/7sharp9">@7sharp9</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        var blacklist = [];
        
          
            blacklist.push('nemerle');
          
            blacklist.push('FSharp.Javascript');
          
            blacklist.push('ServiceStack');
          
        

        github.showRepos({
            user: '7sharp9',
            count: 0,
            skip_forks: false,
            blacklist: blacklist,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Dave Thomas -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'moiraesoftware';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://MoiraeSoftware.com/blog/2011/01/14/sockets-and-bockets-part-2/';
        var disqus_url = 'http://MoiraeSoftware.com/blog/2011/01/14/sockets-and-bockets-part-2/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
