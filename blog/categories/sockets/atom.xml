<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Sockets | Moirae]]></title>
  <link href="http://MoiraeSoftware.github.io/blog/categories/sockets/atom.xml" rel="self"/>
  <link href="http://MoiraeSoftware.github.io/"/>
  <updated>2013-08-18T22:46:30+01:00</updated>
  <id>http://MoiraeSoftware.github.io/</id>
  <author>
    <name><![CDATA[Dave Thomas]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Sockets and Bockets 4]]></title>
    <link href="http://MoiraeSoftware.github.io/blog/2011/01/28/sockets-and-bockets-part-4/"/>
    <updated>2011-01-28T14:31:55+00:00</updated>
    <id>http://MoiraeSoftware.github.io/blog/2011/01/28/sockets-and-bockets-part-4</id>
    <content type="html"><![CDATA[<h2>Welcome to part 4</h2>

<p>If you were looking forward to some exciting new F# code this time your going
to be disappointed, however if you are like me and like looking at graphs and
stats and digging in deeper into the code then your going to enjoy this, lets
get started&hellip;<!-- more --></p>

<p>I set up a 5 minute test with 50 clients connecting to the server with a 15ms
interval between each one.  Once connected each client receives a 128 byte
message from the server every 100ms so this will be a 500 messages per second
test.  I am going to be using an excellent product called <a href="http://bit.ly/e4ToaO">YourKit Profilerfor .NET</a> it can do both memory and CPU profiling as
well as displaying telemetry for things like thread count, stack contents,
memory allocations etc.  It can be configured to be a lot less intrusive than
a lot of other profilers and I have had a lot of success using it.  You can
download a demo from their site using the link above.  I will be doing some
other articles on using profiling and analysis tools later on so stay tuned
for those too.  All of the graphs and information gathered in this post come
from YourKits output during CPU and memory profiling.</p>

<p>Before we start here&rsquo;s a reminder of what the client code looks like, this is
a simple test client using Brian&rsquo;s code as mentioned in
<a href="http://moiraesoftware.com/?p=39">Part1</a> I have highlighted the lines that
have changed below.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Net</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Net</span><span class="p">.</span><span class="nc">Sockets</span>
</span><span class='line'><span class="k">let</span> <span class="n">quoteSize</span> <span class="o">=</span> <span class="mi">128</span>
</span><span class='line'><span class="k">type</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Net</span><span class="p">.</span><span class="nn">Sockets</span><span class="p">.</span><span class="nc">TcpClient</span> <span class="k">with</span>
</span><span class='line'>  <span class="k">member</span> <span class="n">client</span><span class="o">.</span><span class="nc">AsyncConnect</span><span class="o">(</span><span class="n">server</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">clientIndex</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>    <span class="nn">Async</span><span class="p">.</span><span class="nc">FromBeginEnd</span><span class="o">(</span><span class="n">server</span><span class="o">,</span> <span class="n">port</span><span class="o">,(</span><span class="n">client</span><span class="o">.</span><span class="nc">BeginConnect</span> <span class="o">:</span> <span class="nc">IPAddress</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="o">_</span> <span class="o">*</span> <span class="o">_</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="o">_),</span> <span class="n">client</span><span class="o">.</span><span class="nc">EndConnect</span><span class="o">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">clientRequestQuoteStream</span> <span class="o">(</span><span class="n">clientIndex</span><span class="o">,</span> <span class="n">server</span><span class="o">,</span> <span class="n">port</span><span class="o">:</span><span class="kt">int</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>  <span class="n">async</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Net</span><span class="p">.</span><span class="nn">Sockets</span><span class="p">.</span><span class="nc">TcpClient</span><span class="bp">()</span>
</span><span class='line'>    <span class="k">do</span><span class="o">!</span>  <span class="n">client</span><span class="o">.</span><span class="nc">AsyncConnect</span><span class="o">(</span><span class="n">server</span><span class="o">,</span><span class="n">port</span><span class="o">,</span> <span class="n">clientIndex</span><span class="o">)</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="nc">GetStream</span><span class="bp">()</span>
</span><span class='line'>    <span class="k">let</span><span class="o">!</span> <span class="n">header</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="nc">AsyncRead</span> <span class="mi">1</span> <span class="c1">// read header</span>
</span><span class='line'>    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
</span><span class='line'>      <span class="k">let</span><span class="o">!</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="nc">AsyncRead</span> <span class="n">quoteSize</span>
</span><span class='line'>      <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">bytes</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">quoteSize</span> <span class="k">then</span>
</span><span class='line'>        <span class="n">printfn</span> <span class="s2">&quot;client incorrect checksum&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="k">let</span> <span class="n">myLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">obj</span><span class="bp">()</span>
</span><span class='line'><span class="k">let</span> <span class="n">clientAsync</span> <span class="n">clientIndex</span> <span class="o">=</span>
</span><span class='line'>  <span class="n">async</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">do</span><span class="o">!</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">Sleep</span><span class="o">(</span><span class="n">clientIndex</span><span class="o">*</span><span class="mi">15</span><span class="o">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">clientIndex</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span>
</span><span class='line'>      <span class="n">lock</span> <span class="n">myLock</span> <span class="o">(</span><span class="k">fun</span><span class="bp">()</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">printfn</span> <span class="s2">&quot;%d clients...&quot;</span> <span class="n">clientIndex</span><span class="o">)</span>
</span><span class='line'>    <span class="k">try</span>
</span><span class='line'>      <span class="k">do</span><span class="o">!</span> <span class="n">clientRequestQuoteStream</span> <span class="o">(</span><span class="n">clientIndex</span><span class="o">,</span> <span class="nn">IPAddress</span><span class="p">.</span><span class="nc">Loopback</span><span class="o">,</span> <span class="mi">10003</span><span class="o">)</span>
</span><span class='line'>    <span class="k">with</span> <span class="n">e</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>      <span class="n">printfn</span> <span class="s2">&quot;CLIENT %d ERROR: %A&quot;</span> <span class="n">clientIndex</span> <span class="n">e</span>
</span><span class='line'>      <span class="c1">//raise e</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="nn">Async</span><span class="p">.</span><span class="nc">Parallel</span> <span class="o">[</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span> <span class="o">..</span> <span class="mi">50</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">clientAsync</span> <span class="n">i</span> <span class="o">]</span>
</span><span class='line'>  <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">Ignore</span>
</span><span class='line'>  <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">Start</span>
</span><span class='line'><span class="nn">System</span><span class="p">.</span><span class="nn">Console</span><span class="p">.</span><span class="nc">ReadKey</span><span class="bp">()</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">ignore</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h2>CPU and threading performance</h2>

<p>First of all lets look at the CPU results from the <em>IAsync</em> pattern:</p>

<p><img class="<a" src="href="https://lh5.googleusercontent.com/-3H8-TiiB-VI/TwYhL2mvYsI/AAAAAAAABQI/z8dmiHBvTJE/mcnamara-cpu1.png">https://lh5.googleusercontent.com/-3H8-TiiB-VI/TwYhL2mvYsI/AAAAAAAABQI/z8dmiHBvTJE/mcnamara-cpu1.png</a>"></p>

<p>Heres the same run from the SAEA pattern:</p>

<p><img class="<a" src="href="https://lh3.googleusercontent.com/-yGB2zdE3kGM/TwYhLPrUmLI/AAAAAAAABP8/Y6CIMWOi4Gk/Bocket-cpu2.png">https://lh3.googleusercontent.com/-yGB2zdE3kGM/TwYhLPrUmLI/AAAAAAAABP8/Y6CIMWOi4Gk/Bocket-cpu2.png</a>"></p>

<p>You can see that both the number of threads and the amount of CPU is a quite a
lot less in the SAEA pattern.  The spike at the beginning is the allocation of
buffers for the BocketPool.</p>

<p>Now lets move on to memory and garbage collection.</p>

<h2>Memory Allocation</h2>

<p>Here&rsquo;s a graph of the heap and process memory allocation in the <strong>IAsync</strong>
pattern, green is generation 0, blue is generation 1 and orange is the large
object heap.  There&rsquo;s also red for generation 2 but the results are behind the
others and they are only small 0,2 MB peaks at 5 to 15 second intervals.</p>

<p><img class="<a" src="href="https://lh3.googleusercontent.com/-PalohQxAkOg/TwYhL6hR5JI/AAAAAAAABQQ/NtCLYc43OZc/mcnamara-mem1.png">https://lh3.googleusercontent.com/-PalohQxAkOg/TwYhL6hR5JI/AAAAAAAABQQ/NtCLYc43OZc/mcnamara-mem1.png</a>"></p>

<p>Heres the same but for the SAEA pattern, there are red peaks every 10- 20
second intervals of 0.2MB hidden under the others.</p>

<p><img class="<a" src="href="https://lh3.googleusercontent.com/-Nadz1nXQ7lg/TwYhLBXMvcI/AAAAAAAABQM/xCfuXkzkekM/Bocket-mem1.png">https://lh3.googleusercontent.com/-Nadz1nXQ7lg/TwYhLBXMvcI/AAAAAAAABQM/xCfuXkzkekM/Bocket-mem1.png</a>"></p>

<p>As you can see the heap memory is around half the size and the process memory is 15MB less.</p>

<h2>Memory Hotspots</h2>

<p>Finally here&rsquo;s a couple of screen shot of the hot spots for memory allocations
in both implementations</p>

<p><img class="<a" src="href="https://lh4.googleusercontent.com/-n3QWLgvNjq8/TwYhLX8cIZI/AAAAAAAABQA/LkeRno775Ew/s800/IAsync-hot.png">https://lh4.googleusercontent.com/-n3QWLgvNjq8/TwYhLX8cIZI/AAAAAAAABQA/LkeRno775Ew/s800/IAsync-hot.png</a>" title="IAsync" ></p>

<p><img class="<a" src="href="https://lh5.googleusercontent.com/-PSX_YUfxkgU/TwYhMr40DTI/AAAAAAAABQY/D8bgLS6kNwc/s800/SAEA-hot.png">https://lh5.googleusercontent.com/-PSX_YUfxkgU/TwYhMr40DTI/AAAAAAAABQY/D8bgLS6kNwc/s800/SAEA-hot.png</a>" title="SAEA" ></p>

<p>You can clearly the <strong>IAsync</strong> allocations are not present in the SAEA
implementation and there are 310,188 of them, that&rsquo;s 27% of the total garbage!</p>

<h2>Final thoughts</h2>

<p>The SAEA pattern definitely cuts down on memory and CPU usage, yes it adds a
lot of complexity but if your application is dealing with a very high volume
of traffic or clients and you need optimal performance then I think its the
way to go.</p>

<p>The optimisations don&rsquo;t stop there either, if you think about it the receive
Bocketpool is not even used here, if we collapsed all of the BocketPools into
a single contiguous store then we would use even less resources, this means we
could support even more clients or throughput.  In a typical high volume
scenario you are looking at doubling your throughput or number of client
connections.</p>

<p>There&rsquo;s definitely a lot more or interesting things to explore in this area.</p>

<p>As usual any comments are welcome.</p>

<p>See you next time&hellip;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sockets and Bockets 3]]></title>
    <link href="http://MoiraeSoftware.github.io/blog/2011/01/20/sockets-and-bockets-part-3/"/>
    <updated>2011-01-20T01:17:55+00:00</updated>
    <id>http://MoiraeSoftware.github.io/blog/2011/01/20/sockets-and-bockets-part-3</id>
    <content type="html"><![CDATA[<h2>Welcome to part three!</h2>

<p>As promised heres a description of the inner workings.  I&rsquo;m sick to death of
typing SocketAsyncEventArgs so from now on I will refer to it as SAEA.<!-- more --></p>

<p><strong>BocketPool</strong><br/>
The BocketPool has an interesting name and with it an interesting constructor!
It takes the following parameters:</p>

<p><strong>number</strong>: The number of items to create in the BocketPool. <strong>size</strong>: The size of each buffer in bytes. <strong>callback</strong>: A callback function which is invoked whenever the SAEA object completes its operation.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">type</span> <span class="nc">BocketPool</span><span class="o">(</span> <span class="n">number</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">callback</span><span class="o">)</span> <span class="k">as</span> <span class="n">this</span> <span class="o">=&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">let</span> <span class="n">number</span> <span class="o">=</span> <span class="n">number</span>
</span><span class='line'><span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
</span><span class='line'><span class="k">let</span> <span class="n">totalsize</span> <span class="o">=</span> <span class="o">(</span><span class="n">number</span> <span class="o">*</span> <span class="n">size</span><span class="o">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">create</span> <span class="n">totalsize</span> <span class="mi">0</span><span class="n">uy</span>
</span><span class='line'><span class="k">let</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BlockingCollection</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="nc">SocketAsyncEventArgs</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;(</span><span class="n">number</span><span class="o">:</span><span class="kt">int</span><span class="o">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>A <strong>buffer</strong> is created with a size equal to the (<strong>number</strong> * <strong>size</strong>)
in bytes.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">do</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">n</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">n</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="n">x</span> <span class="k">when</span> <span class="n">x</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">totalsize</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>      <span class="k">let</span> <span class="n">saea</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SocketAsyncEventArgs</span><span class="bp">()</span>
</span><span class='line'>      <span class="n">saea</span><span class="o">.</span><span class="nc">Completed</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">add</span> <span class="n">callback</span>
</span><span class='line'>      <span class="n">saea</span><span class="o">.</span><span class="nc">SetBuffer</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">size</span><span class="o">)</span>
</span><span class='line'>      <span class="n">this</span><span class="o">.</span><span class="nc">CheckIn</span><span class="o">(</span><span class="n">saea</span><span class="o">)</span>
</span><span class='line'>      <span class="n">loop</span> <span class="o">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">size</span><span class="o">)</span>
</span><span class='line'>    <span class="o">|</span> <span class="o">_</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="bp">()</span>
</span><span class='line'>  <span class="n">loop</span> <span class="mi">0</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>The tail recursive loop function creates a SAEA object and adds it to the
BlockingCollection(pool).</p>

<p>The buffer is assigned to each SAEA but each is given a unique offset to use,
this is done by the SetBuffer method.  Using this method of allocation, memory
fragmentation is reduced to a minimum by allowing the same buffer to be
reused.</p>

<p>We use the pipeline operator to attach the <strong>Completed</strong> event to the callback
method that is passed in the constructor.</p>

<p>The CheckIn, CheckOut, and Count methods are simply wrappers around the
BlockingCollection.</p>

<p>We also implement <strong>IDisposable</strong> to take care of the disposal of the SAEA in the
BlockingCollection.</p>

<p><strong>Connection</strong><br/>
The main purpose for this type is to encapsulate the sending and receiving of
messages for a particular client. A BocketPool is created for both the send
and receive operations, the receiveCompleted and SentCompleted are invoked
when the respective operations complete.</p>

<p><strong>Send</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Send</span> <span class="o">(</span><span class="n">msg</span><span class="o">:</span><span class="kt">byte</span><span class="bp">[]</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sendPool</span><span class="o">.</span><span class="nc">CheckOut</span><span class="bp">()</span>
</span><span class='line'>  <span class="nn">Buffer</span><span class="p">.</span><span class="nc">BlockCopy</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="nc">Buffer</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="nc">Offset</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="nc">Length</span><span class="o">)</span>
</span><span class='line'>  <span class="n">socket</span><span class="o">.</span><span class="nc">SendAsyncSafe</span><span class="o">(</span><span class="n">this</span><span class="o">.</span><span class="n">sendCompleted</span><span class="o">,</span> <span class="n">s</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Initially a Bocket is checked out of the sendPool using sendPool.Checkout(),
the <strong>msg</strong> byte array is copied to the corresponding <strong>Offset</strong> property of
the SAEA.</p>

<p>Finally the SendAsyncSafe extension method is called passing in the SAEA and
the callback.</p>

<p><strong>sendCompleted</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="n">sendCompleted</span> <span class="o">(</span><span class="n">args</span><span class="o">:</span> <span class="nc">SocketAsyncEventArgs</span><span class="o">)</span> <span class="o">=&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>  <span class="k">try</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="nc">LastOperation</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nn">SocketAsyncOperation</span><span class="p">.</span><span class="nc">Send</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>      <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="nc">SocketError</span> <span class="k">with</span>
</span><span class='line'>      <span class="o">|</span> <span class="nn">SocketError</span><span class="p">.</span><span class="nc">Success</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>        <span class="bp">()</span>
</span><span class='line'>      <span class="o">|</span> <span class="nn">SocketError</span><span class="p">.</span><span class="nc">NoBufferSpaceAvailable</span>
</span><span class='line'>      <span class="o">|</span> <span class="nn">SocketError</span><span class="p">.</span><span class="nc">IOPending</span>
</span><span class='line'>      <span class="o">|</span> <span class="nn">SocketError</span><span class="p">.</span><span class="nc">WouldBlock</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="ow">not</span><span class="o">(</span><span class="n">anyErrors</span><span class="o">)</span> <span class="k">then</span>
</span><span class='line'>          <span class="n">anyErrors</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;-</span> <span class="bp">true</span>
</span><span class='line'>          <span class="n">failwith</span> <span class="s2">&quot;Buffer overflow or send buffer timeout&quot;</span>
</span><span class='line'>      <span class="o">|</span> <span class="o">_</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">args</span><span class="o">.</span><span class="nn">SocketError</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">printfn</span> <span class="s2">&quot;socket error on send: %s&quot;</span>
</span><span class='line'>    <span class="o">|</span> <span class="o">_</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">failwith</span> <span class="s2">&quot;invalid operation, should be receive&quot;</span>
</span><span class='line'>  <span class="k">finally</span>
</span><span class='line'>    <span class="n">sendPool</span><span class="o">.</span><span class="nc">CheckIn</span><span class="o">(</span><span class="n">args</span><span class="o">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This function matches the LastOperation property of the SAEA using pattern
matching, this ensures that the LastOperation is always SocketError.Success.</p>

<p>We raise exceptions on NoBufferSpaceAvailable, IOPending, and WouldBlock as
buffer overflows and match any other conditions the wildcard.</p>

<p>Finally we Check the Bocket back in so that it can be reused.</p>

<p><strong>receiveCompleted</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="n">receiveCompleted</span> <span class="o">(</span><span class="n">args</span><span class="o">:</span> <span class="nc">SocketAsyncEventArgs</span><span class="o">)</span> <span class="o">=&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>  <span class="k">try</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="nc">LastOperation</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nn">SocketAsyncOperation</span><span class="p">.</span><span class="nc">Receive</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>      <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="nc">SocketError</span> <span class="k">with</span>
</span><span class='line'>      <span class="o">|</span> <span class="nn">SocketError</span><span class="p">.</span><span class="nc">Success</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>        <span class="n">socket</span><span class="o">.</span><span class="nc">ReceiveAsyncSafe</span><span class="o">(</span> <span class="n">this</span><span class="o">.</span><span class="n">receiveCompleted</span><span class="o">,</span> <span class="n">receivePool</span><span class="o">.</span><span class="nc">CheckOut</span><span class="bp">()</span><span class="o">)</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">create</span> <span class="n">args</span><span class="o">.</span><span class="nc">BytesTransferred</span> <span class="mi">0</span><span class="n">uy</span>
</span><span class='line'>        <span class="nn">Buffer</span><span class="p">.</span><span class="nc">BlockCopy</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="nc">Buffer</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="nc">Offset</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="nc">Length</span><span class="o">)</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">client</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="nc">RemoteEndPoint</span>
</span><span class='line'>        <span class="n">args</span><span class="o">.</span><span class="nc">RemoteEndPoint</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;-</span> <span class="k">null</span>
</span><span class='line'>        <span class="n">data</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">printfn</span> <span class="s2">&quot;received data: %A&quot;</span>
</span><span class='line'>      <span class="o">|</span> <span class="o">_</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">args</span><span class="o">.</span><span class="nn">SocketError</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">printfn</span> <span class="s2">&quot;socket error on receive: %s&quot;</span>
</span><span class='line'>    <span class="o">|</span> <span class="o">_</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">failwith</span> <span class="s2">&quot;unknown operation, should be receive&quot;</span>
</span><span class='line'>  <span class="k">finally</span>
</span><span class='line'>    <span class="n">receivePool</span><span class="o">.</span><span class="nc">CheckIn</span><span class="o">(</span><span class="n">args</span><span class="o">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This function is very similar to the sendCompleted and could probably be
refactored a bit using the <a href="http://enfranchisedmind.com/blog/posts/the-hole-in-the-middle-%0Apattern/">Hole in the middle
pattern</a>.  Again we check to ensure the last operation was a success, we
checkout another Bocket and start another ReceiveAsyncSafe. This ensures that
the socket can begin another receive operation as soon as possible while we
take the data from the SAEA Buffer, we do this with Buffer.Block copy.</p>

<p>If this were a fully-fledged API then we would raise an event here so that
users of the component could consume the data.</p>

<p>In my own component the data is inserted into a series of processing stages
using the <a href="http://www.cise.ufl.edu/research/ParallelPatterns%0A/PatternLanguage/AlgorithmStructure/Pipeline.htm">Pipeline Pattern</a>, which I will be may
describe in a future post if anyone&rsquo;s interested.</p>

<p><strong>TcpListener</strong><br/>
The TcpListener is very similar to the Connection object in that it has a pool
of SAEA objects that are used to accept connection from clients, again a round
of refactoring could be done here to avoid duplication with the Connection
type.  The main difference is that we don&rsquo;t need to use the Buffer on the SAEA
to send anything to the client when it initially connects.</p>

<p><strong>acceptCompleted</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="n">acceptcompleted</span> <span class="o">(</span><span class="n">args</span> <span class="o">:</span> <span class="nc">SocketAsyncEventArgs</span><span class="o">)</span> <span class="o">=&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>  <span class="k">try</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="nc">LastOperation</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nn">SocketAsyncOperation</span><span class="p">.</span><span class="nc">Accept</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>      <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="nc">SocketError</span> <span class="k">with</span>
</span><span class='line'>      <span class="o">|</span> <span class="nn">SocketError</span><span class="p">.</span><span class="nc">Success</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>        <span class="n">listeningSocket</span><span class="o">.</span><span class="nc">AcceptAsyncSafe</span><span class="o">(</span> <span class="n">this</span><span class="o">.</span><span class="n">acceptcompleted</span><span class="o">,</span> <span class="n">acceptPool</span><span class="o">.</span><span class="nc">Take</span><span class="bp">()</span><span class="o">)</span>
</span><span class='line'>        <span class="c1">//create new connection</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">newConnection</span> <span class="n">args</span><span class="o">.</span><span class="nc">AcceptSocket</span>
</span><span class='line'>        <span class="n">connection</span><span class="o">.</span><span class="nc">Start</span><span class="bp">()</span>
</span><span class='line'>        <span class="c1">//update stats</span>
</span><span class='line'>        <span class="n">reportConnections</span>
</span><span class='line'>        <span class="c1">//async start of messages to client</span>
</span><span class='line'>        <span class="n">startSending</span> <span class="n">connection</span>
</span><span class='line'>        <span class="c1">//remove the AcceptSocket because we will be reusing args</span>
</span><span class='line'>        <span class="n">args</span><span class="o">.</span><span class="nc">AcceptSocket</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;-</span> <span class="k">null</span>
</span><span class='line'>      <span class="o">|</span> <span class="o">_</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">args</span><span class="o">.</span><span class="nn">SocketError</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">printfn</span> <span class="s2">&quot;socket error on accept: %s&quot;</span>
</span><span class='line'>    <span class="o">|</span> <span class="o">_</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">args</span><span class="o">.</span><span class="nc">LastOperation</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">failwith</span> <span class="s2">&quot;Unknown operation, should be accept but was %a&quot;</span>
</span><span class='line'>  <span class="k">finally</span>
</span><span class='line'>    <span class="n">acceptPool</span><span class="o">.</span><span class="nc">Add</span><span class="o">(</span><span class="n">args</span><span class="o">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This function is similar to the send and receive completed methods in the
Connection type, although this time we create a Connection object and call the
Start function, this puts the Connection into receive mode.</p>

<p>The reportConnections is called next which simply prints how many clients are
connected, we now start an Asyncronous workflow using the startSending
function.</p>

<p>Finally we set the AcceptSocket property to null on the SAEA object and add it
back to the BlockingCollection so that it can be reused.</p>

<p>The purpose of the BlockingCollection here is to have a fixed pool of SAEA
that block when there isn&rsquo;t an SAEA to service the new connection, this could
be a potential issue for the client as it could timeout while waiting for a
connection but this is a far preferable situation than causing your server to
be effectively denied service due to overload.</p>

<p><strong>startSending</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">startSending</span> <span class="n">connection</span> <span class="o">=&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>  <span class="nn">Async</span><span class="p">.</span><span class="nc">Start</span> <span class="o">(</span><span class="n">async</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">try</span>
</span><span class='line'>      <span class="k">use</span> <span class="o">_</span><span class="n">holder</span> <span class="o">=</span> <span class="n">connection</span>
</span><span class='line'>      <span class="k">do</span><span class="o">!</span> <span class="n">asyncServiceClient</span> <span class="n">connection</span>
</span><span class='line'>    <span class="k">with</span> <span class="n">e</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="ow">not</span><span class="o">(</span><span class="n">anyErrors</span><span class="o">)</span> <span class="k">then</span>
</span><span class='line'>        <span class="n">anyErrors</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;-</span> <span class="bp">true</span>
</span><span class='line'>        <span class="nn">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="o">(</span><span class="s2">&quot;server ERROR&quot;</span><span class="o">)</span>
</span><span class='line'>      <span class="n">raise</span> <span class="n">e</span>
</span><span class='line'>    <span class="o">}</span> <span class="o">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This function uses the syntactic sugar of the asynchronous workflows to start
an operation on the Thread pool, once queued on the thread pool it is wrapped
in a using block with the <strong><em>use </em>holder = connection_</strong> statement and
asynchronously calls the asyncServiceClient function, this has the effect of
disposing of the Connection type when it exits scope or encounters an
exception.</p>

<p><strong>asyncServiceClient</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">asyncServiceClient</span> <span class="o">(</span><span class="n">client</span><span class="o">:</span> <span class="nc">Connection</span><span class="o">)</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>  <span class="n">client</span><span class="o">.</span><span class="nc">Send</span><span class="o">(</span><span class="n">header</span><span class="o">)</span>
</span><span class='line'>  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
</span><span class='line'>    <span class="k">do</span><span class="o">!</span> <span class="n">asyncWriteStockQuote</span><span class="o">(</span><span class="n">client</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This function sends a one byte header message to the client using the
Connection.Send, followed by calling asyncWriteStockQuote in a continuous
loop.</p>

<p><strong>asyncWriteStockQuote</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">asyncWriteStockQuote</span><span class="o">(</span><span class="n">connection</span><span class="o">:</span><span class="nc">Connection</span><span class="o">)</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>  <span class="k">do</span><span class="o">!</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">Sleep</span> <span class="mi">1000</span>
</span><span class='line'>  <span class="n">connection</span><span class="o">.</span><span class="nc">Send</span><span class="o">(</span><span class="n">testMessage</span><span class="o">)</span>
</span><span class='line'>  <span class="nn">Interlocked</span><span class="p">.</span><span class="nc">Increment</span><span class="o">(&amp;</span><span class="n">amp</span><span class="o">;</span><span class="n">numWritten</span><span class="o">)</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">ignore</span> <span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This function sleeps for 1000ms and uses the Connection.Send function to sent
a message to the client, the number of results is updated using the
Interlocked class.</p>

<p>I would like to refer you to <a href="http://lorgonblog.wordpress.com/2010/03/28/f-async-on-the-server-side/">Brian McNamara&rsquo;s
post</a>
that describes this part in more detail.  The only difference in our workflow
is that we don&rsquo;t use a stream operation as we have the SendAsyncSafe function
to do all the work for us.  IDispose is also implemented on this type too as
we have to dispose of the SAEA objects that are used for the asynchronous
accepts.</p>

<p><strong>createTcpSocket</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">createTcpSocket</span><span class="bp">()</span> <span class="o">=&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>  <span class="k">new</span> <span class="nc">Socket</span><span class="o">(</span><span class="nn">AddressFamily</span><span class="p">.</span><span class="nc">InterNetwork</span><span class="o">,</span> <span class="nn">SocketType</span><span class="p">.</span><span class="nc">Stream</span><span class="o">,</span> <span class="nn">ProtocolType</span><span class="p">.</span><span class="nc">Tcp</span><span class="o">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This function simply wraps the Sockets class constructor mapping it to: Tcp
protocol, Streaming, and InterNetwork Address type.</p>

<p><strong>createListener</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">createListener</span> <span class="o">(</span><span class="n">ip</span><span class="o">:</span><span class="nc">IPAddress</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">backlog</span><span class="o">)</span> <span class="o">=&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>  <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">createTcpSocket</span><span class="bp">()</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="nc">Bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">IPEndPoint</span><span class="o">(</span><span class="n">ip</span><span class="o">,</span> <span class="n">port</span><span class="o">))</span>
</span><span class='line'>  <span class="n">s</span><span class="o">.</span><span class="nc">Listen</span><span class="o">(</span><span class="n">backlog</span><span class="o">);</span> <span class="n">s</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
This function calls the createTcpSocket function, binds to the IPAddress and
port that are passed in and starts listening for connections.</p>

<p><strong>Start</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="n">start</span> <span class="bp">()</span> <span class="o">=&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>  <span class="n">listeningSocket</span><span class="o">.</span><span class="nc">AcceptAsyncSafe</span><span class="o">(</span> <span class="n">this</span><span class="o">.</span><span class="n">acceptcompleted</span><span class="o">,</span> <span class="n">acceptPool</span><span class="o">.</span><span class="nc">Take</span><span class="bp">()</span><span class="o">)</span>
</span><span class='line'>  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
</span><span class='line'>  <span class="nn">Thread</span><span class="p">.</span><span class="nc">Sleep</span> <span class="mi">1000</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="nn">Interlocked</span><span class="p">.</span><span class="nc">Exchange</span><span class="o">(&amp;</span><span class="n">amp</span><span class="o">;</span><span class="n">numWritten</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'>  <span class="n">count</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">printfn</span> <span class="s2">&quot;Quotes per sec: %A&quot;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This function starts the whole process of listening for a connection from
clients.  A SAEA is taken from the BlockingCollection and AcceptAsyncSafe is
called.</p>

<p>I have tried to describe all of the functions that I think merit a description
but I have been involved in this sort of code for years now so if you have any
queries feel free to just drop a comment and I will try to help.</p>

<p>When looking through the code remember that this is just a demo, I am
currently still working on a few things but may offer the full API available
for download at a later date or put it on GitHub.</p>

<p>In part four we are going to compare some of the differences in operation
between the xxxAsync and the IAsync pattern, obviously there is a lot more
code and inherent complexity in this implementation but in high volume
situations it makes a lot of difference.</p>

<p>See you next time.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sockets and Bockets 2]]></title>
    <link href="http://MoiraeSoftware.github.io/blog/2011/01/14/sockets-and-bockets-part-2/"/>
    <updated>2011-01-14T22:29:16+00:00</updated>
    <id>http://MoiraeSoftware.github.io/blog/2011/01/14/sockets-and-bockets-part-2</id>
    <content type="html"><![CDATA[<h3>Welcome to part two</h3>

<p>Lets jump in at the deep end and take a look at some code&hellip;</p>

<p>When you look at the method syntax for the xxxAsync methods you will notice
they return a boolean value that indicates if the method completed
synchronously, this means that you have to check the return value every time
you use one of the methods and invoke the callback yourself if it completes
synchronously.  In practice this hardly ever happens, and normally only on a
send operation.  But as it is a possibility we will add module with a some
extension methods in to help us out, this will make the code more readable and
avoid unnecessary duplication.<!-- more --></p>

<h3>SocketExtensions</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nc">SocketExtensions</span>
</span><span class='line'>  <span class="k">open</span> <span class="nc">System</span>
</span><span class='line'>  <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Net</span>
</span><span class='line'>  <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Net</span><span class="p">.</span><span class="nc">Sockets</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span>
</span><span class='line'>  <span class="k">type</span> <span class="nc">Socket</span> <span class="k">with</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="c1">/// extension method to make async based call easier, this ensures the callback always gets</span>
</span><span class='line'><span class="c1">/// called even if there is an error or the async method completed syncronously</span>
</span><span class='line'><span class="k">member</span> <span class="n">s</span><span class="o">.</span><span class="nc">InvokeAsyncMethod</span><span class="o">(</span> <span class="n">asyncmethod</span><span class="o">,</span> <span class="n">callback</span><span class="o">,</span> <span class="n">args</span><span class="o">:</span><span class="nc">SocketAsyncEventArgs</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">asyncmethod</span> <span class="n">args</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">result</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="bp">true</span> <span class="k">then</span> <span class="n">callback</span> <span class="n">args</span>
</span><span class='line'><span class="k">member</span> <span class="n">s</span><span class="o">.</span><span class="nc">AcceptAsyncSafe</span><span class="o">(</span><span class="n">callback</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="nc">InvokeAsyncMethod</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="nc">AcceptAsync</span><span class="o">,</span> <span class="n">callback</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span>
</span><span class='line'><span class="k">member</span> <span class="n">s</span><span class="o">.</span><span class="nc">ReceiveAsyncSafe</span><span class="o">(</span><span class="n">callback</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="nc">InvokeAsyncMethod</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="nc">ReceiveAsync</span><span class="o">,</span> <span class="n">callback</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span>
</span><span class='line'><span class="k">member</span> <span class="n">s</span><span class="o">.</span><span class="nc">SendAsyncSafe</span><span class="o">(</span><span class="n">callback</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="nc">InvokeAsyncMethod</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="nc">SendAsync</span><span class="o">,</span> <span class="n">callback</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span>
</span><span class='line'><span class="k">member</span> <span class="n">s</span><span class="o">.</span><span class="nc">DisconnectAsyncSafe</span><span class="o">(</span><span class="n">callback</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="nc">InvokeAsyncMethod</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="nc">DisconnectAsync</span><span class="o">,</span> <span class="n">callback</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Now lets get down to business, the next few types have a fair bit of code in
them so I will briefly explain each type in turn:</p>

<h3>BocketPool</h3>

<p>A BocketPool is a combination of a
<a href="http://msdn.microsoft.com/en-%0Aus/library/system.net.sockets.socketasynceventargs.aspx">SocketAsyncEventArgs</a> object and a chunk of
memory allocated in an array.  The array is sliced up into sections and
allocated for each send or receive operation by setting a start and end index
using <a href="http://msdn.microsoft.com/en-us/library/bb549836.aspx">SetBuffer()</a>.
If you remember last time I mentioned that a lot of memory fragmentation can
occur during sending and receiving due to continuously allocating memory
buffers on the Socket object, this is primarily done through the BeginSend and
BeginReceive methods passing in a byte array.  Using the BocketPool it a great
way of reducing the amount of garbage collection during heavy traffic.</p>

<p>The other major difference with SocketAsyncEventArgs is the way in which you
make the send and receive calls, heres the general flow that occurs:</p>

<ul>
<li>Create a SocketAsyncEventArgs object or get one from a pool.</li>
<li>Allocate an array to the buffer.</li>
<li>Allocate an offset and length to the buffer.</li>
<li>Allocate a callback method.</li>
<li>Call Socket.xxxAsync passing in the SocketAsyncEventArgs, the operation will complete and invoke the callback.</li>
</ul>


<p>What we are going to do is wrap the whole creation, array allocation, and
offsetting to the BocketPool:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">namespace</span> <span class="nc">Fes</span>
</span><span class='line'>  <span class="k">open</span> <span class="nc">System</span>
</span><span class='line'>  <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Net</span><span class="p">.</span><span class="nc">Sockets</span>
</span><span class='line'>  <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Collections</span><span class="p">.</span><span class="nc">Concurrent</span>
</span><span class='line'>  <span class="k">type</span> <span class="nc">BocketPool</span><span class="o">(</span> <span class="n">number</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">callback</span><span class="o">)</span> <span class="k">as</span> <span class="n">this</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">number</span> <span class="o">=</span> <span class="n">number</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">totalsize</span> <span class="o">=</span> <span class="o">(</span><span class="n">number</span> <span class="o">*</span> <span class="n">size</span><span class="o">)</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">create</span> <span class="n">totalsize</span> <span class="mi">0</span><span class="n">uy</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BlockingCollection</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="nc">SocketAsyncEventArgs</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;(</span><span class="n">number</span><span class="o">:</span><span class="kt">int</span><span class="o">)</span>
</span><span class='line'>    <span class="k">let</span> <span class="k">mutable</span> <span class="n">disposed</span> <span class="o">=</span> <span class="bp">false</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">cleanUp</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>      <span class="k">if</span> <span class="ow">not</span> <span class="n">disposed</span> <span class="k">then</span>
</span><span class='line'>        <span class="n">disposed</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;-</span> <span class="bp">true</span>
</span><span class='line'>        <span class="n">pool</span><span class="o">.</span><span class="nc">CompleteAdding</span><span class="bp">()</span>
</span><span class='line'>        <span class="k">while</span> <span class="n">pool</span><span class="o">.</span><span class="nc">Count</span> <span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="mi">1</span> <span class="k">do</span>
</span><span class='line'>          <span class="o">(</span><span class="n">pool</span><span class="o">.</span><span class="nc">Take</span><span class="bp">()</span> <span class="o">:&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="nc">IDisposable</span><span class="o">).</span><span class="nc">Dispose</span><span class="bp">()</span>
</span><span class='line'>        <span class="n">pool</span><span class="o">.</span><span class="nc">Dispose</span><span class="bp">()</span>
</span><span class='line'>    <span class="k">do</span>
</span><span class='line'>      <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">n</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">n</span> <span class="k">with</span>
</span><span class='line'>        <span class="o">|</span> <span class="n">x</span> <span class="k">when</span> <span class="n">x</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">totalsize</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>          <span class="k">let</span> <span class="n">saea</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SocketAsyncEventArgs</span><span class="bp">()</span>
</span><span class='line'>          <span class="n">saea</span><span class="o">.</span><span class="nc">Completed</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">add</span><span class="o">(</span> <span class="k">fun</span> <span class="n">saea</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="o">(</span><span class="n">callback</span> <span class="n">saea</span><span class="o">))</span>
</span><span class='line'>          <span class="n">saea</span><span class="o">.</span><span class="nc">SetBuffer</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">size</span><span class="o">)</span>
</span><span class='line'>          <span class="n">this</span><span class="o">.</span><span class="nc">CheckIn</span><span class="o">(</span><span class="n">saea</span><span class="o">)</span>
</span><span class='line'>          <span class="n">loop</span> <span class="o">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">size</span><span class="o">)</span>
</span><span class='line'>        <span class="o">|</span> <span class="o">_</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="bp">()</span>
</span><span class='line'>      <span class="n">loop</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">CheckOut</span><span class="bp">()</span><span class="o">=</span>
</span><span class='line'>      <span class="n">pool</span><span class="o">.</span><span class="nc">Take</span><span class="bp">()</span>
</span><span class='line'>    <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">CheckIn</span><span class="o">(</span><span class="n">saea</span><span class="o">)=</span>
</span><span class='line'>      <span class="n">pool</span><span class="o">.</span><span class="nc">Add</span><span class="o">(</span><span class="n">saea</span><span class="o">)</span>
</span><span class='line'>    <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Count</span> <span class="o">=</span>
</span><span class='line'>      <span class="n">pool</span><span class="o">.</span><span class="nc">Count</span>
</span><span class='line'>    <span class="k">interface</span> <span class="nc">IDisposable</span> <span class="k">with</span>
</span><span class='line'>      <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Dispose</span><span class="bp">()</span> <span class="o">=</span> <span class="n">cleanUp</span><span class="bp">()</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Next up we have to look at the Connection and the Tcplistener types as two
interconnected entities:</p>

<ul>
<li>The TcpListener listens for a connection on a socket and port number.</li>
<li>The client connects to the server.</li>
<li>An accept socket is allocated to the client, at this point we have one socket for the server and once for each client.</li>
<li>We also need to allocate a BocketPool for send and receive operation for each client
To simplify things we are going to encapsulate the accept socket management
into a type, it will also need a corresponding BocketPool to service any send
and receive operations to and from the client</li>
</ul>


<h3>Connection</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">namespace</span> <span class="nc">Fes</span>
</span><span class='line'>  <span class="k">open</span> <span class="nc">System</span>
</span><span class='line'>  <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Net</span>
</span><span class='line'>  <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Net</span><span class="p">.</span><span class="nc">Sockets</span>
</span><span class='line'>  <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Collections</span><span class="p">.</span><span class="nc">Generic</span>
</span><span class='line'>  <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Collections</span><span class="p">.</span><span class="nc">Concurrent</span>
</span><span class='line'>  <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Threading</span>
</span><span class='line'>  <span class="k">open</span> <span class="nc">SocketExtensions</span>
</span><span class='line'>  <span class="k">type</span> <span class="nc">Connection</span><span class="o">(</span><span class="n">maxreceives</span><span class="o">,</span> <span class="n">maxsends</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">socket</span><span class="o">:</span><span class="nc">Socket</span><span class="o">)</span> <span class="k">as</span> <span class="n">this</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">maxreceives</span> <span class="o">=</span> <span class="n">maxreceives</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">maxsends</span> <span class="o">=</span> <span class="n">maxsends</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">sendPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BocketPool</span><span class="o">(</span><span class="n">maxsends</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">this</span><span class="o">.</span><span class="n">sendCompleted</span> <span class="o">)</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">receivePool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BocketPool</span><span class="o">(</span><span class="n">maxreceives</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">this</span><span class="o">.</span><span class="n">receiveCompleted</span><span class="o">)</span>
</span><span class='line'>    <span class="k">let</span> <span class="k">mutable</span> <span class="n">disposed</span> <span class="o">=</span> <span class="bp">false</span>
</span><span class='line'>    <span class="k">let</span> <span class="k">mutable</span> <span class="n">anyErrors</span> <span class="o">=</span> <span class="bp">false</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">cleanUp</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>      <span class="k">if</span> <span class="ow">not</span> <span class="n">disposed</span> <span class="k">then</span>
</span><span class='line'>        <span class="n">disposed</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;-</span> <span class="bp">true</span>
</span><span class='line'>        <span class="n">socket</span><span class="o">.</span><span class="nc">Shutdown</span><span class="o">(</span><span class="nn">SocketShutdown</span><span class="p">.</span><span class="nc">Both</span><span class="o">)</span>
</span><span class='line'>        <span class="n">socket</span><span class="o">.</span><span class="nc">Disconnect</span><span class="o">(</span><span class="bp">false</span><span class="o">)</span>
</span><span class='line'>        <span class="n">socket</span><span class="o">.</span><span class="nc">Close</span><span class="bp">()</span>
</span><span class='line'>        <span class="o">(</span><span class="n">sendPool</span> <span class="o">:&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="nc">IDisposable</span><span class="o">).</span><span class="nc">Dispose</span><span class="bp">()</span>
</span><span class='line'>        <span class="o">(</span><span class="n">receivePool</span> <span class="o">:&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="nc">IDisposable</span><span class="o">).</span><span class="nc">Dispose</span><span class="bp">()</span>
</span><span class='line'>    <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Start</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>      <span class="n">socket</span><span class="o">.</span><span class="nc">ReceiveAsyncSafe</span><span class="o">(</span><span class="n">this</span><span class="o">.</span><span class="n">receiveCompleted</span><span class="o">,</span> <span class="n">receivePool</span><span class="o">.</span><span class="nc">CheckOut</span><span class="bp">()</span><span class="o">)</span>
</span><span class='line'>    <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Stop</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>      <span class="n">socket</span><span class="o">.</span><span class="nc">Close</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'>    <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="n">receiveCompleted</span> <span class="o">(</span><span class="n">args</span><span class="o">:</span> <span class="nc">SocketAsyncEventArgs</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>      <span class="k">try</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="nc">LastOperation</span> <span class="k">with</span>
</span><span class='line'>        <span class="o">|</span> <span class="nn">SocketAsyncOperation</span><span class="p">.</span><span class="nc">Receive</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>          <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="nc">SocketError</span> <span class="k">with</span>
</span><span class='line'>          <span class="o">|</span> <span class="nn">SocketError</span><span class="p">.</span><span class="nc">Success</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>            <span class="n">socket</span><span class="o">.</span><span class="nc">ReceiveAsyncSafe</span><span class="o">(</span> <span class="n">this</span><span class="o">.</span><span class="n">receiveCompleted</span><span class="o">,</span> <span class="n">receivePool</span><span class="o">.</span><span class="nc">CheckOut</span><span class="bp">()</span><span class="o">)</span>
</span><span class='line'>            <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">create</span> <span class="n">args</span><span class="o">.</span><span class="nc">BytesTransferred</span> <span class="mi">0</span><span class="n">uy</span>
</span><span class='line'>            <span class="nn">Buffer</span><span class="p">.</span><span class="nc">BlockCopy</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="nc">Buffer</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="nc">Offset</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="nc">Length</span><span class="o">)</span>
</span><span class='line'>            <span class="k">let</span> <span class="n">client</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="nc">RemoteEndPoint</span>
</span><span class='line'>            <span class="n">args</span><span class="o">.</span><span class="nc">RemoteEndPoint</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;-</span> <span class="k">null</span>
</span><span class='line'>            <span class="n">data</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">printfn</span> <span class="s2">&quot;received data: %A&quot;</span>
</span><span class='line'>          <span class="o">|</span> <span class="o">_</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">args</span><span class="o">.</span><span class="nn">SocketError</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">printfn</span> <span class="s2">&quot;socket error on receive: %s&quot;</span>
</span><span class='line'>        <span class="o">|</span> <span class="o">_</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">failwith</span> <span class="s2">&quot;unknown operation, should be receive&quot;</span>
</span><span class='line'>      <span class="k">finally</span>
</span><span class='line'>        <span class="n">receivePool</span><span class="o">.</span><span class="nc">CheckIn</span><span class="o">(</span><span class="n">args</span><span class="o">)</span>
</span><span class='line'>    <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="n">sendCompleted</span> <span class="o">(</span><span class="n">args</span><span class="o">:</span> <span class="nc">SocketAsyncEventArgs</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>      <span class="k">try</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="nc">LastOperation</span> <span class="k">with</span>
</span><span class='line'>        <span class="o">|</span> <span class="nn">SocketAsyncOperation</span><span class="p">.</span><span class="nc">Send</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>          <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="nc">SocketError</span> <span class="k">with</span>
</span><span class='line'>          <span class="o">|</span> <span class="nn">SocketError</span><span class="p">.</span><span class="nc">Success</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="bp">()</span>
</span><span class='line'>          <span class="o">|</span> <span class="nn">SocketError</span><span class="p">.</span><span class="nc">NoBufferSpaceAvailable</span>
</span><span class='line'>          <span class="o">|</span> <span class="nn">SocketError</span><span class="p">.</span><span class="nc">IOPending</span>
</span><span class='line'>          <span class="o">|</span> <span class="nn">SocketError</span><span class="p">.</span><span class="nc">WouldBlock</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="ow">not</span><span class="o">(</span><span class="n">anyErrors</span><span class="o">)</span> <span class="k">then</span>
</span><span class='line'>              <span class="n">anyErrors</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;-</span> <span class="bp">true</span>
</span><span class='line'>              <span class="n">failwith</span> <span class="s2">&quot;Buffer overflow or send buffer timeout&quot;</span>
</span><span class='line'>          <span class="o">|</span> <span class="o">_</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">args</span><span class="o">.</span><span class="nn">SocketError</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">printfn</span> <span class="s2">&quot;socket error on send: %s&quot;</span>
</span><span class='line'>        <span class="o">|</span> <span class="o">_</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">failwith</span> <span class="s2">&quot;invalid operation, should be receive&quot;</span>
</span><span class='line'>      <span class="k">finally</span>
</span><span class='line'>        <span class="n">sendPool</span><span class="o">.</span><span class="nc">CheckIn</span><span class="o">(</span><span class="n">args</span><span class="o">)</span>
</span><span class='line'>    <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Send</span> <span class="o">(</span><span class="n">msg</span><span class="o">:</span><span class="kt">byte</span><span class="bp">[]</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>      <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sendPool</span><span class="o">.</span><span class="nc">CheckOut</span><span class="bp">()</span>
</span><span class='line'>      <span class="nn">Buffer</span><span class="p">.</span><span class="nc">BlockCopy</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="nc">Buffer</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="nc">Offset</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="nc">Length</span><span class="o">)</span>
</span><span class='line'>      <span class="n">socket</span><span class="o">.</span><span class="nc">SendAsyncSafe</span><span class="o">(</span><span class="n">this</span><span class="o">.</span><span class="n">sendCompleted</span><span class="o">,</span> <span class="n">s</span><span class="o">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Finally here&rsquo;s the TcpListener type.  It is responsible for creating an
initial Connection object for each client and starts asynchronous sending
messages to that client once a second, also notice that there is another
BlockingCollection involved, this is somewhat simpler than the usage in the
bocketPool as we have no buffer to manage here.</p>

<ul>
<li><em>It is possible to fill the initial Buffer property, this causes the buffer to be sent to the client as soon as it has connected to the server, this can be useful to sent initial data to the client, such as protocol definitions etc)</em>
A finite number of connections can occur before blocking will occur depending
on the number of AsyncEventArgs in the collection, this stops potential denial
of service attacks due to too many connection being made.</li>
</ul>


<h3>TcpListener</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">namespace</span> <span class="nc">Fes</span>
</span><span class='line'>  <span class="k">open</span> <span class="nc">System</span>
</span><span class='line'>  <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Net</span>
</span><span class='line'>  <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Net</span><span class="p">.</span><span class="nc">Sockets</span>
</span><span class='line'>  <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Collections</span><span class="p">.</span><span class="nc">Generic</span>
</span><span class='line'>  <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Collections</span><span class="p">.</span><span class="nc">Concurrent</span>
</span><span class='line'>  <span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Threading</span>
</span><span class='line'>  <span class="k">open</span> <span class="nc">SocketExtensions</span>
</span><span class='line'>  <span class="k">type</span> <span class="nc">TcpListener</span><span class="o">(</span><span class="n">maxaccepts</span><span class="o">,</span> <span class="n">maxsends</span><span class="o">,</span> <span class="n">maxreceives</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">backlog</span><span class="o">)</span> <span class="k">as</span> <span class="n">this</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">createTcpSocket</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>      <span class="k">new</span> <span class="nc">Socket</span><span class="o">(</span><span class="nn">AddressFamily</span><span class="p">.</span><span class="nc">InterNetwork</span><span class="o">,</span> <span class="nn">SocketType</span><span class="p">.</span><span class="nc">Stream</span><span class="o">,</span> <span class="nn">ProtocolType</span><span class="p">.</span><span class="nc">Tcp</span><span class="o">)</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">createListener</span> <span class="o">(</span><span class="n">ip</span><span class="o">:</span><span class="nc">IPAddress</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">backlog</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>      <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">createTcpSocket</span><span class="bp">()</span>
</span><span class='line'>      <span class="n">s</span><span class="o">.</span><span class="nc">Bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">IPEndPoint</span><span class="o">(</span><span class="n">ip</span><span class="o">,</span> <span class="n">port</span><span class="o">))</span>
</span><span class='line'>      <span class="n">s</span><span class="o">.</span><span class="nc">Listen</span><span class="o">(</span><span class="n">backlog</span><span class="o">);</span> <span class="n">s</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">listeningSocket</span> <span class="o">=</span> <span class="n">createListener</span><span class="o">(</span> <span class="nn">IPAddress</span><span class="p">.</span><span class="nc">Loopback</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">backlog</span><span class="o">)</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">initPool</span> <span class="o">(</span><span class="n">maxinpool</span><span class="o">,</span> <span class="n">callback</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>      <span class="k">let</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BlockingCollection</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="nc">SocketAsyncEventArgs</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;(</span><span class="n">maxinpool</span><span class="o">:</span><span class="kt">int</span><span class="o">)</span>
</span><span class='line'>      <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">n</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">n</span> <span class="k">with</span>
</span><span class='line'>        <span class="o">|</span> <span class="n">x</span> <span class="k">when</span> <span class="n">x</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">maxinpool</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>          <span class="k">let</span> <span class="n">saea</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SocketAsyncEventArgs</span><span class="bp">()</span>
</span><span class='line'>          <span class="n">saea</span><span class="o">.</span><span class="nc">Completed</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">add</span> <span class="n">callback</span>
</span><span class='line'>          <span class="n">pool</span><span class="o">.</span><span class="nc">Add</span> <span class="n">saea</span>
</span><span class='line'>          <span class="n">loop</span> <span class="o">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'>        <span class="o">|</span> <span class="o">_</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="bp">()</span>
</span><span class='line'>      <span class="n">loop</span> <span class="mi">0</span>
</span><span class='line'>      <span class="n">pool</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">acceptPool</span> <span class="o">=</span> <span class="n">initPool</span> <span class="o">(</span><span class="n">maxaccepts</span><span class="o">,</span> <span class="n">this</span><span class="o">.</span><span class="n">acceptcompleted</span><span class="o">)</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">newConnection</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Connection</span> <span class="o">(</span><span class="n">maxreceives</span><span class="o">,</span> <span class="n">maxsends</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">socket</span><span class="o">)</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">testMessage</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">init</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="kt">byte</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="mi">128</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="mi">1</span><span class="n">uy</span><span class="o">)</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">header</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">init</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="kt">byte</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="mi">1</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="mi">1</span><span class="n">uy</span><span class="o">)</span>
</span><span class='line'>    <span class="k">let</span> <span class="k">mutable</span> <span class="n">disposed</span> <span class="o">=</span> <span class="bp">false</span>
</span><span class='line'>    <span class="c1">//mutable state from original</span>
</span><span class='line'>    <span class="k">let</span> <span class="k">mutable</span> <span class="n">anyErrors</span> <span class="o">=</span> <span class="bp">false</span>
</span><span class='line'>    <span class="k">let</span> <span class="k">mutable</span> <span class="n">requestCount</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">let</span> <span class="k">mutable</span> <span class="n">numWritten</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="c1">//async code from original</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">asyncWriteStockQuote</span><span class="o">(</span><span class="n">connection</span><span class="o">:</span><span class="nc">Connection</span><span class="o">)</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">do</span><span class="o">!</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">Sleep</span> <span class="mi">1000</span>
</span><span class='line'>      <span class="n">connection</span><span class="o">.</span><span class="nc">Send</span><span class="o">(</span><span class="n">testMessage</span><span class="o">)</span>
</span><span class='line'>      <span class="nn">Interlocked</span><span class="p">.</span><span class="nc">Increment</span><span class="o">(&amp;</span><span class="n">amp</span><span class="o">;</span><span class="n">numWritten</span><span class="o">)</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">ignore</span> <span class="o">}</span>
</span><span class='line'>    <span class="c1">//async code from original</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">asyncServiceClient</span> <span class="o">(</span><span class="n">client</span><span class="o">:</span> <span class="nc">Connection</span><span class="o">)</span> <span class="o">=</span> <span class="n">async</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">client</span><span class="o">.</span><span class="nc">Send</span><span class="o">(</span><span class="n">header</span><span class="o">)</span>
</span><span class='line'>      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
</span><span class='line'>        <span class="k">do</span><span class="o">!</span> <span class="n">asyncWriteStockQuote</span><span class="o">(</span><span class="n">client</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">startSending</span> <span class="n">connection</span> <span class="o">=</span>
</span><span class='line'>      <span class="nn">Async</span><span class="p">.</span><span class="nc">Start</span> <span class="o">(</span><span class="n">async</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span>
</span><span class='line'>          <span class="k">use</span> <span class="o">_</span><span class="n">holder</span> <span class="o">=</span> <span class="n">connection</span>
</span><span class='line'>          <span class="k">do</span><span class="o">!</span> <span class="n">asyncServiceClient</span> <span class="n">connection</span>
</span><span class='line'>        <span class="k">with</span> <span class="n">e</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>          <span class="k">if</span> <span class="ow">not</span><span class="o">(</span><span class="n">anyErrors</span><span class="o">)</span> <span class="k">then</span>
</span><span class='line'>            <span class="n">anyErrors</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;-</span> <span class="bp">true</span>
</span><span class='line'>            <span class="nn">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="o">(</span><span class="s2">&quot;server ERROR&quot;</span><span class="o">)</span>
</span><span class='line'>          <span class="n">raise</span> <span class="n">e</span>
</span><span class='line'>        <span class="o">}</span> <span class="o">)</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">reportConnections</span> <span class="o">=</span>
</span><span class='line'>      <span class="nn">Interlocked</span><span class="p">.</span><span class="nc">Increment</span><span class="o">(&amp;</span><span class="n">amp</span><span class="o">;</span><span class="n">requestCount</span><span class="o">)</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">ignore</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">requestCount</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span>
</span><span class='line'>        <span class="n">requestCount</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">printfn</span> <span class="s2">&quot;%A Clients accepted&quot;</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">cleanUp</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>      <span class="k">if</span> <span class="ow">not</span> <span class="n">disposed</span> <span class="k">then</span>
</span><span class='line'>        <span class="n">disposed</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;-</span> <span class="bp">true</span>
</span><span class='line'>        <span class="n">listeningSocket</span><span class="o">.</span><span class="nc">Shutdown</span><span class="o">(</span><span class="nn">SocketShutdown</span><span class="p">.</span><span class="nc">Both</span><span class="o">)</span>
</span><span class='line'>        <span class="n">listeningSocket</span><span class="o">.</span><span class="nc">Disconnect</span><span class="o">(</span><span class="bp">false</span><span class="o">)</span>
</span><span class='line'>        <span class="n">listeningSocket</span><span class="o">.</span><span class="nc">Close</span><span class="bp">()</span>
</span><span class='line'>    <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="n">acceptcompleted</span> <span class="o">(</span><span class="n">args</span> <span class="o">:</span> <span class="nc">SocketAsyncEventArgs</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>      <span class="k">try</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="nc">LastOperation</span> <span class="k">with</span>
</span><span class='line'>        <span class="o">|</span> <span class="nn">SocketAsyncOperation</span><span class="p">.</span><span class="nc">Accept</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>          <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="nc">SocketError</span> <span class="k">with</span>
</span><span class='line'>          <span class="o">|</span> <span class="nn">SocketError</span><span class="p">.</span><span class="nc">Success</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'>            <span class="n">listeningSocket</span><span class="o">.</span><span class="nc">AcceptAsyncSafe</span><span class="o">(</span> <span class="n">this</span><span class="o">.</span><span class="n">acceptcompleted</span><span class="o">,</span> <span class="n">acceptPool</span><span class="o">.</span><span class="nc">Take</span><span class="bp">()</span><span class="o">)</span>
</span><span class='line'>            <span class="c1">//create new connection</span>
</span><span class='line'>            <span class="k">let</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">newConnection</span> <span class="n">args</span><span class="o">.</span><span class="nc">AcceptSocket</span>
</span><span class='line'>            <span class="n">connection</span><span class="o">.</span><span class="nc">Start</span><span class="bp">()</span>
</span><span class='line'>            <span class="c1">//update stats</span>
</span><span class='line'>            <span class="n">reportConnections</span>
</span><span class='line'>            <span class="c1">//async start of messages to client</span>
</span><span class='line'>            <span class="n">startSending</span> <span class="n">connection</span>
</span><span class='line'>            <span class="c1">//remove the AcceptSocket because we will be reusing args</span>
</span><span class='line'>            <span class="n">args</span><span class="o">.</span><span class="nc">AcceptSocket</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;-</span> <span class="k">null</span>
</span><span class='line'>          <span class="o">|</span> <span class="o">_</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">args</span><span class="o">.</span><span class="nn">SocketError</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">printfn</span> <span class="s2">&quot;socket error on accept: %s&quot;</span>
</span><span class='line'>        <span class="o">|</span> <span class="o">_</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">args</span><span class="o">.</span><span class="nc">LastOperation</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">failwith</span> <span class="s2">&quot;Unknown operation, should be accept but was %a&quot;</span>
</span><span class='line'>      <span class="k">finally</span>
</span><span class='line'>        <span class="n">acceptPool</span><span class="o">.</span><span class="nc">Add</span><span class="o">(</span><span class="n">args</span><span class="o">)</span>
</span><span class='line'>    <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="n">start</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>      <span class="n">listeningSocket</span><span class="o">.</span><span class="nc">AcceptAsyncSafe</span><span class="o">(</span> <span class="n">this</span><span class="o">.</span><span class="n">acceptcompleted</span><span class="o">,</span> <span class="n">acceptPool</span><span class="o">.</span><span class="nc">Take</span><span class="bp">()</span><span class="o">)</span>
</span><span class='line'>      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
</span><span class='line'>      <span class="nn">Thread</span><span class="p">.</span><span class="nc">Sleep</span> <span class="mi">1000</span>
</span><span class='line'>      <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="nn">Interlocked</span><span class="p">.</span><span class="nc">Exchange</span><span class="o">(&amp;</span><span class="n">amp</span><span class="o">;</span><span class="n">numWritten</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'>      <span class="n">count</span> <span class="o">|&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">printfn</span> <span class="s2">&quot;Quotes per sec: %A&quot;</span>
</span><span class='line'>    <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Close</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>      <span class="n">cleanUp</span><span class="bp">()</span>
</span><span class='line'>    <span class="k">interface</span> <span class="nc">IDisposable</span> <span class="k">with</span>
</span><span class='line'>      <span class="k">member</span> <span class="n">this</span><span class="o">.</span><span class="nc">Dispose</span><span class="bp">()</span> <span class="o">=</span> <span class="n">cleanUp</span><span class="bp">()</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Its a fair bit of code to take in at once, so Ill leave you with it to ponder
over.  Ill be explaining all of the interesting bits in more detail in part
three&hellip;</p>

<p>Please feel free to leave any comments you have, especially on better use of
functional constructs.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sockets and Bockets 1]]></title>
    <link href="http://MoiraeSoftware.github.io/blog/2011/01/13/sockets-and-bockets-1/"/>
    <updated>2011-01-13T01:38:06+00:00</updated>
    <id>http://MoiraeSoftware.github.io/blog/2011/01/13/sockets-and-bockets-1</id>
    <content type="html"><![CDATA[<h3>Welcome to part 1</h3>

<p>A while back I read an interesting article by <em>Brian McNamara</em> <a href="http://lorgonblog.wordpress.com/2010/03/28/f-async-on-the-server-side/">f-async-on-the-server-side</a>
which describes C# and F# versions of a simple asynchronous
socket server, one of the driving forces behind the article was how F# can
wrap the traditional asynchronous model with <a href="http://msdn.microsoft.com/en-us/library/dd233250.aspx">Asynchronous Workflows</a>, this
produces nice clean simple code compared to the C# version which uses lambda
expressions, the code looks quite ugly in this style!  However thats not the
end of the story, a lot of memory fragmentation can occur using the APM model
when there is a high throughput, so I thought I would see if I could take this
a step further&hellip;<!-- more --></p>

<p>There are some lesser known methods that were added to the <a href="http://msdn.microsoft.com/en-us/library/system.net.sockets.socket.aspx">Socket</a>
class in .Net 2.0 SP1: ReceiveAsync, SendAsync, ConnectAsync and DisconnectAsync.
These methods use an event driven model and <strong>do not</strong> result in the creation
of AsyncResult objects, these are created on every asynchronous call in the
traditional Socket Begin/End methods.  Once you have thousands of clients
sending and receiving thousands of messages all of the object creation can
really have an adverse effect on performance on the garbage collected, you
will regularly see the AsyncResult objects hitting Generation 1 and 2.</p>

<p>To use the xxxAsync methods you have pass a <a href="http://msdn.microsoft.com/en-us/library/system.net.sockets.socketasynceventargs.aspx">SocketAsyncEventArgs</a>object which is
assigned callback method and a buffer, the callback method called
asynchronously when the operation completes and is passed the corresponding
SocketAsyncEventArgs object, this allows you query the buffer in a receive
operation.</p>

<p>The scope of this series of articles is to initially replicate Brian&rsquo;s demo
using F# and a pool of SocketAsyncEventArgs and a contiguous block of memory
to hold the data being sent and received on the Socket, this again further
reduces memory fragmentation on the send and receive buffers.</p>

<p>I have successfully developed an enterprise server for a client using this
method, it processed thousands of simultaneous connected clients and messages,
key components in the system were the High performance sockets, a pipeline
processor and a highly efficiency means of data compaction, I will only be
including the High performance sockets in this series but the other components
will be at a later date in separate articles.  Interestingly all of the code
was originally developed in c# but had a distinctly functional style, even the
Pipeline Processing is reminiscent of functional composition using the F#
pipeline operator <strong>|></strong> although an analogue of attach and detach was used
which in itself is declarative.</p>

<p>Although there is no code in this article there is plenty in the next!</p>

<p>Please feel free to leave comments or add any suggestions, hope to see you
next time&hellip;</p>
]]></content>
  </entry>
  
</feed>
